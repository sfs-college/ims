{% extends "sidebar_base.html" %}
{% load static %}

{% block title %} | Import Preview
{% endblock title %}
{% block navbar %}
{% include "room_incharge/navbar.html" %}
{% endblock navbar %} 
{% block sidebar %}
{% include "room_incharge/sidebar.html" %}
{% endblock sidebar %}

{% block style %}
<link rel="stylesheet" href="{% static 'styles/inventory/room_incharge/purchase_list/style.css' %}">
<style>
    .import-wrapper {
        padding: 20px 28px;
    }
    .import-box {
        background: #fff;
        padding: 30px;
        border-radius: 12px;
        border: 1px solid #e5e5e5;
        box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }
    .import-box h3 {
        font-weight: 700;
        margin-bottom: 12px;
    }
    .desc-text {
        color: #555;
        font-size: 15px;
        line-height: 1.5;
    }
    input[type="file"] {
        padding: 8px !important;
        border-radius: 6px;
    }
</style>
{% endblock style %}

{% block content %} 
<div class="container-fluid px-4 preview-wrapper">
   <h3 class="section-heading">Import Preview</h3>
    <p class="text-muted">Review all values before confirming import.</p>
     {% if has_errors %}
      <div class="alert alert-danger"> <strong>Validation Issues Found.</strong> Fix them in the Excel file and re-upload. </div>
       {% endif %} 
       {% if preview.errors %} 
       <div class="alert alert-warning"> 
        <h5 class="fw-semibold">Global Errors</h5> 
        <ul>
           {% for e in preview.errors %} 
          <li>{{ e }}</li> 
          {% endfor %} 
        </ul>
       </div> 
       {% endif %} 
       {% if preview.items %} 
       <h5 class="mt-4 mb-2 fw-bold">Items Preview</h5>
        <div class="table-responsive mb-4"> 
          <table class="table table-bordered table-sm align-middle"> 
            <thead> 
              <tr> 
                <th>Row</th> 
                <th>Item Description</th> 
                <th>Category</th> 
                <th>Opening Qty</th> 
                <th>Arrival</th> 
                <th>Total</th> 
                <th>Closing</th> 
                <th>Errors</th> 
              </tr> 
            </thead> 
              <tbody> 
                {% for r in preview.items %} 
                <tr>
                   <td>{{ r.rownum }}</td>
                   <td>{{ r.sanitized.item_description }}</td>
                   <td>{{ r.sanitized.category }}</td>
                   <td>{{ r.sanitized.opening }}</td> 
                   <td>{{ r.sanitized.arrival }}</td>
                   <td>{{ r.sanitized.total }}</td>
                   <td>{{ r.sanitized.closing }}</td>
                   <td> {% if r.errors %}
                    <ul class="error-list text-danger small"> 
                      {% for er in r.errors %} 
                      <li>{{ er }}</li> 
                      {% endfor %} 
                    </ul> 
                    {% else %}
                     <span class="text-success fw-semibold">OK</span>
                      {% endif %} 
                    </td>
                   </tr>
                    {% endfor %}
                   </tbody> 
                  </table>
                 </div>
                  {% endif %}
                   {% if preview.purchases %}
                    <h5 class="fw-bold mb-2">Purchases Preview</h5>
                     <div class="table-responsive mb-4">
                       <table class="table table-bordered table-sm align-middle"> 
                        <thead> 
                          <tr> 
                            <th>Row</th> 
                            <th>Date</th> 
                            <th>Description</th> 
                            <th>Model</th> 
                            <th>Serial No</th> 
                            <th>Qty</th> 
                            <th>Unit</th> 
                            <th>Vendor</th> 
                            <th>Errors</th> 
                          </tr> 
                        </thead> 
                        <tbody> 
                          {% for r in preview.purchases %} 
                          <tr> 
                            <td>{{ r.rownum }}</td> 
                            <td>{{ r.sanitized.date }}</td> 
                            <td>{{ r.sanitized.item_description }}</td> 
                            <td>{{ r.sanitized.model_code }}</td> 
                            <td>{{ r.sanitized.serial_no }}</td> 
                            <td>{{ r.sanitized.quantity }}</td> 
                            <td>{{ r.sanitized.uom }}</td> 
                            <td>{{ r.sanitized.vendor }}</td> 
                            <td> 
                              {% if r.errors %} 
                              <ul class="error-list text-danger small"> 
                                {% for er in r.errors %}
                   <li>{{ er }}</li> 
                  {% endfor %}
                 </ul> 
                  {% else %}
                   <span class="text-success fw-semibold">OK</span> 
                  {% endif %} 
                </td> 
                </tr> 
                  {% endfor %} 
                </tbody> 
                </table> 
                </div> 
                {% endif %}
                 <div class="confirm-box"> <h5 class="fw-bold">Confirm Import</h5> <p>Re-upload the same Excel file to confirm final import.</p> <form method="post" action="{% url 'room_incharge:purchase_import_confirm' room_slug=room_slug %}" enctype="multipart/form-data"> 
                  {% csrf_token %} 
                  <div class="mb-3"> <label class="fw-semibold">Upload Excel File Again</label> 
                    <input type="file" name="file" class="form-control" required> 
                  </div>
                 <button class="btn btn-success px-4" type="submit" 
                 {% if has_errors %}disabled{% endif %}> Confirm Import </button> 
                  <a href="{% url 'room_incharge:purchase_import' room_slug=room_slug %}" class="btn btn-secondary ms-2"> Cancel </a> 
                  {% if has_errors %}
                   <div class="text-muted mt-2">Resolve errors to enable import.</div> 
                   {% endif %} 
                  </form>
               </div> 
              </div> 
                {% endblock content %}