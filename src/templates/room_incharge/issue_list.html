{% extends "sidebar_base.html" %}
{% load static %}

{% block title %} | Issue List{% endblock title %}

{% block style %}
<link rel="stylesheet" href="{% static 'styles/inventory/room_incharge/issue_list/style.css' %}">
{% endblock style %}

{% block navbar %}
{% include "room_incharge/navbar.html" %}
{% endblock navbar %}

{% block sidebar %}
{% include "room_incharge/sidebar.html" %}
{% endblock sidebar %}

{% block content %}
<h3 class="my-3">Issues for {{ room.room_name }}</h3>

<div class="table-responsive">
    <table class="table table-sm align-middle">
        <thead>
            <tr>
                <th>Sno.</th>
                <th>Subject</th>
                <th>Raised By</th>
                <th>Status</th>
                <th>TAT Deadline</th>
                <th class="text-center">Actions</th>
            </tr>
        </thead>

        <tbody>
        {% for issue in issues %}
            <tr>
                <td>{{ forloop.counter }}</td>

                <td class="text-wrap">
                    <a href="#"
                       data-bs-toggle="modal"
                       data-bs-target="#issueModal{{ issue.id }}"
                       class="fw-semibold text-decoration-none">
                        {{ issue.subject }}
                    </a>
                </td>

                <!-- RAISED BY COLUMN -->
                <td>
                    {{ issue.created_by|default:"-" }}
                </td>

                <td>
                    {% if issue.status == "open" %}
                        <span class="badge bg-secondary">Open</span>
                    {% elif issue.status == "in_progress" %}
                        <span class="badge bg-warning text-dark">In Progress</span>
                    {% elif issue.status == "escalated" %}
                        <span class="badge bg-danger">Escalated</span>
                    {% elif issue.status == "closed" %}
                        <span class="badge bg-success">Resolved</span>
                    {% endif %}
                </td>

                <td>
                    {% if issue.tat_deadline %}
                        {{ issue.tat_deadline|date:"M d, Y H:i" }}
                    {% else %}-{% endif %}
                </td>

                <!-- ACTIONS COLUMN -->
                <td class="text-center" style="width: 180px;">
                    <div class="d-grid gap-1">

                        {% if issue.status == "open" %}
                            <form method="post" action="{% url 'room_incharge:in_progress' room.slug issue.pk %}">
                                {% csrf_token %}
                                <button class="btn btn-sm btn-warning w-100">In Progress</button>
                            </form>

                            {% if issue.issuetimerequest_set.exists %}
                                <button class="btn btn-sm btn-secondary w-100" disabled> Extension Pending </button>
                            {% else %}
                                <button class="btn btn-sm btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#tatModal{{ issue.id }}">
                                    ⏱ Request Time Extension
                                </button>
                            {% endif %}
                        {% endif %}

                        {% if issue.status == "in_progress" %}
                            <form method="post" action="{% url 'room_incharge:resolve' room.slug issue.pk %}">
                                {% csrf_token %}
                                <button class="btn btn-sm btn-success w-100">Resolve</button>
                            </form>

                            {% if issue.issuetimerequest_set.exists %}
                                <button class="btn btn-sm btn-secondary w-100" disabled> Extension Pending </button>
                            {% else %}
                                <button class="btn btn-sm btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#tatModal{{ issue.id }}">
                                    ⏱ Request Time Extension
                                </button>
                            {% endif %}
                        {% endif %}

                        {% if issue.status == "closed" %}
                            <form method="post" action="{% url 'room_incharge:unresolve' room.slug issue.pk %}">
                                {% csrf_token %}
                                <button class="btn btn-sm btn-outline-danger w-100">Unresolve</button>
                            </form>
                        {% endif %}

                        {% if issue.status == "escalated" %}
                            {% if issue.issuetimerequest_set.exists %}
                                <button class="btn btn-sm btn-secondary w-100" disabled> Extension Pending </button>
                            {% else %}
                                <button class="btn btn-sm btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#tatModal{{ issue.id }}">
                                    ⏱ Request Time Extension
                                </button>
                            {% endif %}
                        {% endif %}

                    </div>
                </td>
            </tr>

            <!-- ISSUE DETAILS MODAL -->
            <div class="modal fade" id="issueModal{{ issue.id }}" tabindex="-1">
                <div class="modal-dialog modal-dialog-scrollable modal-md">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">{{ issue.subject }}</h5>
                            <button class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p>{{ issue.description }}</p>
                            <hr>
                            <p><strong>Ticket ID:</strong> {{ issue.ticket_id }}</p>
                            <p><strong>Raised By:</strong> {{ issue.created_by|default:"-" }}</p>
                            <p><strong>Status:</strong> {{ issue.get_status_display }}</p>
                            <p><strong>TAT Deadline:</strong> {{ issue.tat_deadline }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ⏱ TIME EXTENSION MODAL -->
            <div class="modal fade" id="tatModal{{ issue.id }}" tabindex="-1">
                <div class="modal-dialog modal-md">
                    <div class="modal-content">
                        <form method="post"
                              action="{% url 'room_incharge:issue_time_extension_request' issue.id %}">
                            {% csrf_token %}
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    Request Additional Time
                                </h5>
                                <button class="btn-close" data-bs-dismiss="modal"></button>
                            </div>

                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">
                                        Additional Hours Required
                                    </label>
                                    <input type="number"
                                           name="requested_extra_hours"
                                           class="form-control"
                                           min="1"
                                           required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">
                                        Reason <span class="text-danger">*</span>
                                    </label>
                                    <textarea name="reason"
                                              class="form-control"
                                              rows="3"
                                              required
                                              aria-required="true"
                                              placeholder="Explain why extra time is required"></textarea>
                                </div>
                            </div>

                            <div class="modal-footer">
                                <button class="btn btn-primary">
                                    Submit Request
                                </button>
                                <button class="btn btn-secondary"
                                        data-bs-dismiss="modal">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

        {% endfor %}
        </tbody>
    </table>
</div>
{% endblock content %}
