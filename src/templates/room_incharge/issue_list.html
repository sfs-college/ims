{% extends "sidebar_base.html" %}
{% load static %}

{% block title %} | Issue List{% endblock title %}

{% block style %}
<link rel="stylesheet" href="{% static 'styles/inventory/room_incharge/issue_list/style.css' %}">
<style>
    /* ── Toast notification ──────────────────────────────────────── */
    #toastContainer {
        position: fixed;
        top: 24px;
        right: 24px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 12px;
        pointer-events: none;
    }
    .bx-toast {
        display: flex;
        align-items: flex-start;
        gap: 14px;
        background: #ffffff;
        border-radius: 14px;
        padding: 16px 20px;
        min-width: 320px;
        max-width: 400px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.10), 0 1px 4px rgba(0,0,0,0.06);
        border-left: 4px solid #198754;
        pointer-events: auto;
        opacity: 0;
        transform: translateX(40px);
        animation: toastIn 0.4s cubic-bezier(0.22,1,0.36,1) forwards,
                   toastOut 0.35s ease 4s forwards;
    }
    .bx-toast.toast-error { border-left-color: #dc3545; }
    @keyframes toastIn  { to { opacity: 1; transform: translateX(0); } }
    @keyframes toastOut { to { opacity: 0; transform: translateX(40px); } }

    .bx-toast-icon {
        width: 36px; height: 36px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        flex-shrink: 0; font-size: 1rem; font-weight: 700;
    }
    .toast-icon-success { background: rgba(25,135,84,0.12); color: #198754; }
    .toast-icon-error   { background: rgba(220,53,69,0.12);  color: #dc3545; }

    .bx-toast-body { flex: 1; }
    .bx-toast-title { font-weight: 700; font-size: 0.9rem; color: #1a1a1a; margin-bottom: 2px; }
    .bx-toast-msg   { font-size: 0.82rem; color: #666; line-height: 1.4; margin: 0; }

    .bx-toast-close {
        background: none; border: none; font-size: 1rem; color: #aaa;
        cursor: pointer; padding: 0; line-height: 1; flex-shrink: 0;
        transition: color 0.2s;
    }
    .bx-toast-close:hover { color: #333; }
</style>
{% endblock style %}

{% block navbar %}{% include "room_incharge/navbar.html" %}{% endblock navbar %}
{% block sidebar %}{% include "room_incharge/sidebar.html" %}{% endblock sidebar %}

{% block content %}

<!-- Toast container -->
<div id="toastContainer"></div>

<!-- Django messages stash (invisible, read by JS on load) -->
{% if messages %}
<div id="djangoMessages" style="display:none">
    {% for message in messages %}
    <span data-tags="{{ message.tags }}" data-text="{{ message|escapejs }}"></span>
    {% endfor %}
</div>
{% endif %}

<h3 class="my-3">Issues for {{ room.room_name }}</h3>

<div class="table-responsive">
    <table class="table table-sm align-middle">
        <thead>
            <tr>
                <th>Sno.</th>
                <th>Subject</th>
                <th>Raised By</th>
                <th>Status</th>
                <th>TAT Deadline</th>
                <th class="text-center">Actions</th>
            </tr>
        </thead>
        <tbody>
        {% for issue in issues %}
        <tr>
            <td>{{ forloop.counter }}</td>

            <td class="text-wrap">
                <a href="#" data-bs-toggle="modal" data-bs-target="#issueModal{{ issue.id }}"
                   class="fw-semibold text-decoration-none">
                    {{ issue.subject }}
                </a>
            </td>

            <td>{{ issue.created_by|default:"-" }}</td>

            <td>
                {% if issue.status == "open" %}
                    <span class="badge bg-secondary">Open</span>
                {% elif issue.status == "in_progress" %}
                    <span class="badge bg-warning text-dark">In Progress</span>
                {% elif issue.status == "escalated" %}
                    <span class="badge bg-danger">Escalated</span>
                {% elif issue.status == "closed" %}
                    <span class="badge bg-success">Resolved</span>
                {% endif %}
            </td>

            <td>
                {% if issue.tat_deadline %}{{ issue.tat_deadline|date:"M d, Y H:i" }}{% else %}-{% endif %}
            </td>

            <!-- ACTIONS -->
            <td class="text-center" style="width:210px;">
                <div class="d-grid gap-1">

                    {% if issue.status == "escalated" %}
                        {# ── ESCALATED: no actions allowed ── #}
                        <span class="badge bg-danger w-100 py-2" style="font-size:0.75rem;border-radius:8px;">
                            <i class="bi bi-arrow-up-circle me-1"></i>Escalated to Admin
                        </span>
                        <small class="text-muted" style="font-size:0.70rem;">No further actions available</small>

                    {% else %}

                        {% if issue.status == "open" %}
                        <form method="post" action="{% url 'room_incharge:in_progress' room.slug issue.pk %}">
                            {% csrf_token %}
                            <button class="btn btn-sm btn-warning w-100">In Progress</button>
                        </form>
                        {% endif %}

                        {% if issue.status == "in_progress" %}
                        <form method="post" action="{% url 'room_incharge:resolve' room.slug issue.pk %}">
                            {% csrf_token %}
                            <button class="btn btn-sm btn-success w-100">Resolve</button>
                        </form>
                        {% endif %}

                        {% if issue.status == "closed" %}
                        <form method="post" action="{% url 'room_incharge:unresolve' room.slug issue.pk %}">
                            {% csrf_token %}
                            <button class="btn btn-sm btn-outline-danger w-100">Unresolve</button>
                        </form>
                        {% endif %}

                        {# Time Extension — only for non-closed, non-escalated issues #}
                        {% if issue.status != "closed" %}
                            {% with latest=issue.time_extension_requests.last %}
                                {% if not latest %}
                                    <button class="btn btn-sm btn-outline-primary w-100"
                                            data-bs-toggle="modal"
                                            data-bs-target="#tatModal{{ issue.id }}">
                                        ⏱ Request Time Extension
                                    </button>

                                {% elif latest.status == "pending" %}
                                    <button class="btn btn-sm btn-secondary w-100"
                                            disabled style="opacity:0.7;font-size:0.75rem;">
                                        ⏳ Extension Pending…
                                    </button>

                                {% elif latest.status == "approved" %}
                                    <button class="btn btn-sm btn-outline-success w-100"
                                            disabled style="opacity:0.75;font-size:0.75rem;">
                                        ✓ Extension Approved
                                    </button>

                                {% elif latest.status == "rejected" %}
                                    <button class="btn btn-sm btn-outline-warning w-100"
                                            data-bs-toggle="modal"
                                            data-bs-target="#tatModal{{ issue.id }}">
                                        ↩ Re-request Extension
                                    </button>
                                {% endif %}
                            {% endwith %}
                        {% endif %}

                    {% endif %}{# end escalated check #}

                </div>
            </td>
        </tr>

        <!-- ISSUE DETAILS MODAL -->
        <div class="modal fade" id="issueModal{{ issue.id }}" tabindex="-1">
            <div class="modal-dialog modal-dialog-scrollable modal-md">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">{{ issue.subject }}</h5>
                        <button class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>{{ issue.description }}</p>
                        <hr>
                        <p><strong>Ticket ID:</strong> {{ issue.ticket_id }}</p>
                        <p><strong>Raised By:</strong> {{ issue.created_by|default:"-" }}</p>
                        <p><strong>Reporter Email:</strong> {{ issue.reporter_email|default:"-" }}</p>
                        <p><strong>Status:</strong> {{ issue.get_status_display }}</p>
                        <p><strong>TAT Deadline:</strong> {{ issue.tat_deadline }}</p>

                        {% if issue.time_extension_requests.exists %}
                        <hr>
                        <p class="fw-semibold mb-2">Extension Request History</p>
                        {% for ext in issue.time_extension_requests.all %}
                        <div class="d-flex align-items-start gap-2 mb-2 small p-2 rounded"
                             style="background:#f8f9fa;">
                            {% if ext.status == "pending" %}
                                <span class="badge bg-warning text-dark mt-1">Pending</span>
                            {% elif ext.status == "approved" %}
                                <span class="badge bg-success mt-1">Approved</span>
                            {% elif ext.status == "rejected" %}
                                <span class="badge bg-danger mt-1">Rejected</span>
                            {% endif %}
                            <div>
                                <div class="fw-semibold">+{{ ext.requested_extra_hours }} hours</div>
                                <div class="text-muted">{{ ext.reason }}</div>
                            </div>
                        </div>
                        {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- TIME EXTENSION MODAL -->
        <div class="modal fade" id="tatModal{{ issue.id }}" tabindex="-1">
            <div class="modal-dialog modal-md">
                <div class="modal-content" style="border-radius:16px;overflow:hidden;">
                    <form method="post"
                          action="{% url 'room_incharge:issue_time_extension_request' issue.id %}">
                        {% csrf_token %}
                        <div class="modal-header" style="background:#f8f9fa;">
                            <div>
                                <h5 class="modal-title fw-bold mb-0">Request Time Extension</h5>
                                <p class="text-muted small mb-0">Ticket: {{ issue.ticket_id }} — {{ issue.subject }}</p>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">
                                    Additional Hours Required <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <input type="number" name="requested_extra_hours"
                                           class="form-control" min="1" max="168"
                                           placeholder="e.g. 24" required>
                                    <span class="input-group-text text-muted">hours</span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">
                                    Reason <span class="text-danger">*</span>
                                </label>
                                <textarea name="reason" class="form-control" rows="3" required
                                          placeholder="Explain why extra time is needed…"
                                          style="resize:none;"></textarea>
                            </div>
                            <div class="rounded-3 p-3 small text-muted"
                                 style="background:rgba(13,110,253,0.05);border:1px solid rgba(13,110,253,0.12);">
                                <i class="bi bi-info-circle me-1"></i>
                                Your request will be sent to the admin for review. The extension
                                button will be disabled until a decision is made.
                            </div>
                        </div>
                        <div class="modal-footer" style="border-top:1px solid #eee;">
                            <button type="submit" class="btn btn-primary px-4">Submit Request</button>
                            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {% endfor %}
        </tbody>
    </table>
</div>

<script>
/* ── Toast helper ───────────────────────────────────── */
function showToast(title, message, isError) {
    var container = document.getElementById('toastContainer');
    var toast = document.createElement('div');
    toast.className = 'bx-toast' + (isError ? ' toast-error' : '');
    toast.innerHTML =
        '<div class="bx-toast-icon ' + (isError ? 'toast-icon-error' : 'toast-icon-success') + '">' +
            (isError ? '✕' : '✓') +
        '</div>' +
        '<div class="bx-toast-body">' +
            '<div class="bx-toast-title">' + title + '</div>' +
            '<p class="bx-toast-msg">' + message + '</p>' +
        '</div>' +
        '<button class="bx-toast-close" onclick="this.closest(\'.bx-toast\').remove()">✕</button>';
    container.appendChild(toast);
    setTimeout(function() { if (toast.parentNode) toast.remove(); }, 4500);
}

/* ── Convert Django messages to toasts on page load ── */
document.addEventListener('DOMContentLoaded', function () {
    var box = document.getElementById('djangoMessages');
    if (!box) return;
    box.querySelectorAll('span[data-text]').forEach(function(el) {
        var tags  = el.dataset.tags  || '';
        var text  = el.dataset.text  || '';
        var isErr = tags.indexOf('error') !== -1;
        showToast(isErr ? 'Error' : 'Request Sent', text, isErr);
    });
});
</script>

{% endblock content %}