{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Venue Booking | IMS</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #64748b;
            --accent: #10b981;
            --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.5);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg-gradient);
            color: #1e293b;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .booking-container { max-width: 1000px; margin: 0 auto; }

        .glass-header {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05);
        }

        .glass-header h2 {
            font-weight: 800;
            background: linear-gradient(to right, #4f46e5, #9333ea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 40px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.1);
        }

        .form-label { font-weight: 700; color: var(--secondary); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }

        .form-control, .form-select {
            border: 2px solid #e2e8f0;
            border-radius: 14px;
            padding: 14px 18px;
            transition: all 0.2s ease;
        }

        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }

        /* Custom Booking Type Selector */
        .booking-type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .type-card {
            background: #fff; border: 2px solid #e2e8f0; border-radius: 18px; padding: 20px;
            cursor: pointer; transition: 0.3s; text-align: center;
        }
        .type-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .type-card.active { border-color: var(--primary); background: #f5f3ff; box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.1); }

        /* Movie-Styled Room Cards */
        #roomGrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }

        .room-item {
            background: #fff;
            border-radius: 20px;
            padding: 24px;
            border: 2px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
        }

        .room-item:hover { transform: translateY(-8px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }

        .room-item.available.selected {
            border-color: var(--primary);
            background: #f5f3ff;
            box-shadow: 0 0 0 5px rgba(99, 102, 241, 0.1);
        }

        .room-item.booked { background: #f1f5f9; opacity: 0.6; cursor: not-allowed; }

        .status-pill {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 800;
            text-transform: uppercase;
        }
        .available .status-pill { background: #dcfce7; color: #166534; }
        .booked .status-pill { background: #fee2e2; color: #991b1b; }

        .btn-confirm {
            background: linear-gradient(135deg, var(--primary), #9333ea);
            color: white;
            border: none;
            border-radius: 18px;
            padding: 20px;
            font-weight: 800;
            width: 100%;
            margin-top: 40px;
            transition: all 0.3s ease;
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3);
        }
    </style>
</head>
<body>

<div class="booking-container">
    <div class="glass-header">
        <a href="{% url 'landing_page' %}" class="btn btn-sm btn-outline-secondary mb-3 rounded-pill px-3">
                <i class="bi bi-arrow-left me-1"></i> Dashboard
            </a>
        <h2><i class="bi bi-calendar-check-fill me-2"></i> Premium Venue Reservation</h2>
        <p class="text-muted">High-end space management for SFS College Faculty</p>
    </div>

    <div class="glass-card">
        <form method="post" id="bookingForm">
            {% csrf_token %}
            
            <div class="section-title mb-4">
                <span class="badge bg-primary rounded-pill px-3 mb-2">Step 1</span>
                <h4 class="fw-bold">Faculty Identification</h4>
            </div>

            <div class="row g-4 mb-5">
                <div class="col-md-6">
                    <label class="form-label"><i class="bi bi-person-circle"></i> Faculty Full Name</label>
                    {{ form.faculty_name }}
                </div>
                <div class="col-md-6">
                    <label class="form-label"><i class="bi bi-envelope-at-fill"></i> College Email Address</label>
                    {{ form.faculty_email }}
                </div>
            </div>

            <div class="section-title mb-4">
                <span class="badge bg-primary rounded-pill px-3 mb-2">Step 2</span>
                <h4 class="fw-bold">Purpose of Booking</h4>
            </div>
            <div class="mb-5">
                <label class="form-label"><i class="bi bi-chat-left-text-fill"></i> Description</label>
                {{ form.purpose }}
            </div>

            <div class="section-title mb-4">
                <span class="badge bg-primary rounded-pill px-3 mb-2">Step 3</span>
                <h4 class="fw-bold">Space Selection</h4>
            </div>

            <div class="mb-4">
                <label class="form-label">Category</label>
                {{ form.category }}
            </div>

            <div id="roomGrid" class="mb-5"></div>

            <input type="hidden" name="room" id="id_room" required>

            <div class="section-title mb-4">
                <span class="badge bg-primary rounded-pill px-3 mb-2">Step 4</span>
                <h4 class="fw-bold">Scheduling</h4>
            </div>

            <div class="booking-type-grid">
                <div class="type-card active" id="typeWholeDay" onclick="switchType('whole')">
                    <i class="bi bi-clock-fill mb-2 h4 d-block"></i>
                    <strong>Whole Day</strong><br><small>08:00 AM - 04:00 PM</small>
                </div>
                <div class="type-card" id="typeCustom" onclick="switchType('custom')">
                    <i class="bi bi-sliders2-vertical mb-2 h4 d-block"></i>
                    <strong>Custom Time</strong><br><small>Specific start & end</small>
                </div>
            </div>

            <div id="wholeDaySection" class="p-4 border rounded-4 mb-5 bg-white">
                <label class="form-label">Booking Date</label>
                <input type="date" class="form-control" id="wholeDayDate" onchange="updateWholeDayTimes()">
            </div>

            <div id="customTimeSection" class="row g-4 mb-5 d-none">
                <div class="col-md-6">
                    <label class="form-label">From</label>
                    {{ form.start_datetime }}
                </div>
                <div class="col-md-6">
                    <label class="form-label">To</label>
                    {{ form.end_datetime }}
                </div>
            </div>

            <div class="mb-4">
                <label class="form-label">Department</label>
                {{ form.department }}
            </div>

            <button type="submit" class="btn btn-confirm">
                <i class="bi bi-shield-lock-fill me-2"></i> Finalize Booking
            </button>
        </form>
    </div>
</div>

<script>
let currentMode = 'whole';

function switchType(mode) {
    currentMode = mode;
    document.getElementById('typeWholeDay').classList.toggle('active', mode === 'whole');
    document.getElementById('typeCustom').classList.toggle('active', mode === 'custom');
    document.getElementById('wholeDaySection').classList.toggle('d-none', mode === 'custom');
    document.getElementById('customTimeSection').classList.toggle('d-none', mode === 'whole');
    loadRooms();
}

function updateWholeDayTimes() {
    const dateInput = document.getElementById('wholeDayDate').value;
    if (dateInput) {
        const start = `${dateInput}T08:00`;
        const end = `${dateInput}T16:00`;
        
        document.getElementById('id_start_datetime').value = start;
        document.getElementById('id_end_datetime').value = end;
        loadRooms();
    }
}

function loadRooms() {
    const category = document.getElementById("id_category").value;
    const start = document.getElementById("id_start_datetime").value;
    const end = document.getElementById("id_end_datetime").value;

    if (!category || !start || !end) return;

    const params = new URLSearchParams({
        category: category,
        start: start,
        end: end
    });

    fetch(`{% url 'core:rooms_by_category' %}?${params.toString()}`)
        .then(res => {
            if (!res.ok) throw new Error('Network response was not ok');
            return res.json();
        })
        .then(data => {
            const grid = document.getElementById("roomGrid");
            grid.innerHTML = "";
        
            if (data.length === 0) {
                grid.innerHTML = '<div class="col-12 text-center text-muted">No rooms available in this category.</div>';
                return;
            }
            
            data.forEach(room => {
                const roomDiv = document.createElement("div");
                roomDiv.className = `room-item ${room.available ? 'available' : 'booked'}`;
                roomDiv.innerHTML = `
                    <span class="status-pill">${room.available ? 'Available' : 'Booked'}</span>
                    <h5 class="mt-3">${room.name}</h5>
                    <div class="small text-muted mt-2"><i class="bi bi-people-fill"></i> Capacity: ${room.capacity || 40} Seats</div>
                `;

                if (room.available) {
                    roomDiv.onclick = () => {
                        document.querySelectorAll(".room-card").forEach(r => r.classList.remove("selected"));
                        roomDiv.classList.add("selected");
                        document.getElementById("id_room").value = room.id;
                    };
                }
                grid.appendChild(roomDiv);
            });
        })
        .catch(err => console.error("Error loading rooms:", err));
}

document.getElementById("id_category").addEventListener("change", loadRooms);
document.getElementById("id_start_datetime").addEventListener("change", loadRooms);
document.getElementById("id_end_datetime").addEventListener("change", loadRooms);
</script>

</body>
</html>