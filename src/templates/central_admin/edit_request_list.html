{% extends 'sidebar_base.html' %}
{% load static %}

{% block content %}

<style>
/* ---------- Page Container ---------- */
.admin-card {
    background: #fff;
    border-radius: 12px;
    padding: 24px 28px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
}

/* ---------- Header ---------- */
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.page-header h2 {
    font-weight: 700;
    margin-bottom: 0;
}

/* ---------- Table ---------- */
.table thead th {
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: #6c757d;
    border-bottom: 2px solid #dee2e6;
}

.table tbody tr {
    transition: background 0.2s ease;
}

.table tbody tr:hover {
    background-color: #f8f9fa;
}

/* ---------- Badges ---------- */
.badge-pending {
    background: #fff3cd;
    color: #856404;
    font-weight: 600;
}

/* ---------- Detail Card ---------- */
.detail-card {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 20px;
}

/* ---------- Buttons ---------- */
.btn-action {
    min-width: 100px;
}
</style>

<div class="admin-card">

    <!-- HEADER -->
    <div class="page-header">
        <div>
            <a href="{% url 'central_admin:dashboard' %}" class="btn btn-sm btn-outline-secondary mb-3 rounded-pill px-3">
                <i class="bi bi-arrow-left me-1"></i> Dashboard
            </a>
            <h2>Edit Requests Pending Approval</h2>
            <p class="text-muted mb-0">
                Review and take action on pending inventory and issue requests.
            </p>
        </div>

        <form method="get">
            <select name="type"
                    class="form-select shadow-sm"
                    style="width: 260px;"
                    onchange="this.form.submit()">
                <option value="item"
                    {% if request_type == "item" %}selected{% endif %}>
                    Item Edit Requests
                </option>
                <option value="issue"
                    {% if request_type == "issue" %}selected{% endif %}>
                    Issue Time Extension Requests
                </option>
            </select>
        </form>
    </div>

    <!-- TABLE -->
    <div class="table-responsive">
        <table class="table align-middle">
            <thead>
                {% if request_type == "item" %}
                <tr>
                    <th>Item</th>
                    <th>Room</th>
                    <th>Requested By</th>
                    <th>Status</th>
                    <th class="text-end">Action</th>
                </tr>
                {% else %}
                <tr>
                    <th>Issue</th>
                    <th>Requested By</th>
                    <th>Current SLA</th>
                    <th>Extra Time</th>
                    <th>Reason</th>
                    <th class="text-end">Action</th>
                </tr>
                {% endif %}
            </thead>

            <tbody>

            {% for r in requests %}

                {% if request_type == "item" %}
                <!-- ITEM EDIT REQUEST -->
                <tr>
                    <td class="fw-semibold">{{ r.item.item_name }}</td>
                    <td>{{ r.room.room_name }}</td>
                    <td>{{ r.requested_by }}</td>
                    <td>
                        <span class="badge badge-pending rounded-pill">
                            Pending
                        </span>
                    </td>
                    <td class="text-end">
                        <button class="btn btn-outline-primary btn-sm"
                                onclick="toggleDetails('{{ r.id }}')">
                            View Details
                        </button>
                    </td>
                </tr>

                <tr id="details-{{ r.id }}" class="d-none">
                    <td colspan="5">
                        <div class="detail-card mt-3">

                            <div class="row g-4">
                                <div class="col-md-6">
                                    <h6 class="fw-bold text-secondary mb-2">
                                        Current Item Details
                                    </h6>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item">
                                            <strong>Name:</strong> {{ r.item.item_name }}
                                        </li>
                                        <li class="list-group-item">
                                            <strong>Description:</strong> {{ r.item.item_description }}
                                        </li>
                                        <li class="list-group-item">
                                            <strong>Total:</strong> {{ r.item.total_count }}
                                        </li>
                                        <li class="list-group-item">
                                            <strong>Available:</strong> {{ r.item.available_count }}
                                        </li>
                                    </ul>
                                </div>

                                <div class="col-md-6">
                                    <h6 class="fw-bold text-warning mb-2">
                                        Requested Changes
                                    </h6>
                                    <ul class="list-group list-group-flush">
                                        {% for key, value in r.proposed_data.items %}
                                        <li class="list-group-item">
                                            <strong>{{ key|capfirst }}:</strong> {{ value }}
                                        </li>
                                        {% empty %}
                                        <li class="list-group-item text-muted">
                                            No changes provided.
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>

                            <div class="mt-3">
                                <strong>Reason:</strong>
                                <div class="mt-1 text-muted">
                                    {{ r.reason }}
                                </div>
                            </div>

                            <div class="d-flex gap-3 mt-4">
                                <form method="post"
                                      action="{% url 'central_admin:approve_edit_request' r.pk %}">
                                    {% csrf_token %}
                                    <button class="btn btn-success btn-action">
                                        Approve
                                    </button>
                                </form>

                                <form method="post"
                                      action="{% url 'central_admin:reject_edit_request' r.pk %}">
                                    {% csrf_token %}
                                    <button class="btn btn-outline-danger btn-action">
                                        Reject
                                    </button>
                                </form>
                            </div>

                        </div>
                    </td>
                </tr>

                {% else %}
                <!-- ISSUE TIME EXTENSION -->
                <tr>
                    <td class="fw-semibold">
                        #{{ r.issue.ticket_id }}
                    </td>
                    <td>{{ r.requested_by }}</td>
                    <td>{{ r.current_tat_hours }} hrs</td>
                    <td class="fw-bold text-warning">
                        +{{ r.requested_extra_hours }} hrs
                    </td>
                    <td style="max-width: 280px;">
                        {{ r.reason }}
                    </td>
                    <td class="text-end">
                        <div class="d-flex justify-content-end gap-2">
                            <form method="post"
                                  action="{% url 'central_admin:approve_issue_time_extension' r.pk %}">
                                {% csrf_token %}
                                <button class="btn btn-success btn-sm">
                                    Approve
                                </button>
                            </form>

                            <form method="post"
                                  action="{% url 'central_admin:reject_issue_time_extension' r.pk %}">
                                {% csrf_token %}
                                <button class="btn btn-outline-danger btn-sm">
                                    Reject
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endif %}

            {% empty %}
                <tr>
                    <td colspan="6" class="text-center text-muted py-5">
                        No pending requests.
                    </td>
                </tr>
            {% endfor %}

            </tbody>
        </table>
    </div>

</div>

<script>
function toggleDetails(id) {
    const row = document.getElementById("details-" + id);
    if (row) row.classList.toggle("d-none");
}
</script>

{% endblock %}
