{% extends "sidebar_base.html" %}
{% load static %}

{% block title %} | AURA Command Center{% endblock title %}

{% block style %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<style>
    :root { --aura-primary: #3b82f6; --aura-dark: #0f172a; --aura-accent: #10b981; }
    body { background-color: #f8fafc; }
    .aura-header { margin-bottom: 2rem; }
    .stat-card {
        background: white; border: none; border-radius: 15px;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 20px;
        transition: 0.3s;
    }
    .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    .chart-container { background: white; border-radius: 20px; padding: 20px; margin-bottom: 45px; border: 1px solid #e2e8f0; }
    .manager-card {
        background: white; border: 1px solid #e2e8f0; border-radius: 20px; cursor: pointer;
        padding: 30px; text-align: center; transition: all 0.3s ease;
    }
    .manager-card:hover { 
        background: var(--aura-primary); color: white !important; 
        transform: scale(1.02); box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.2);
    }
    .manager-card i { font-size: 2.5rem; margin-bottom: 15px; display: block; }
    
    /* Modal Customization */
    .modal-content { border-radius: 20px; border: none; }
    .modal-header { background: var(--aura-dark); color: white; border-radius: 20px 20px 0 0; padding: 1.5rem; }
    .btn-close-white { filter: invert(1) grayscale(100%) brightness(200%); }
    .report-table thead { position: sticky; top: 0; background: var(--aura-dark); color: white; }
    .table-responsive {
        overflow: visible !important;
        max-height: none !important;
    }
    
    #reportContainer table {
        width: 100% !important;
        background-color: white !important;
    }
</style>
{% endblock style %}

{% block content %}
<div class="container-fluid py-4">
    <div class="aura-header d-flex justify-content-between align-items-center">
        <div>
            <a href="{% url 'central_admin:dashboard' %}" class="btn btn-sm btn-outline-secondary mb-3 rounded-pill px-3">
                <i class="bi bi-arrow-left me-1"></i> Dashboard
            </a>
            <h1 class="fw-bold text-dark mb-0">AURA <span class="text-primary">Command</span></h1>
            <p class="text-muted mb-0">Admin Unified Report & Analysis System</p>
        </div>
        <div class="text-end">
            <span class="badge bg-primary px-3 py-2 rounded-pill"><i class="bi bi-broadcast me-1"></i> LIVE SYSTEM DATA</span>
        </div>
    </div>

    <div class="row mb-4 text-center">
        <div class="col-md-3">
            <div class="stat-card">
                <small class="text-uppercase fw-bold text-muted">Escalated Issues</small>
                <h2 class="fw-bold text-danger mt-1">{{ escalated_count }}</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <small class="text-uppercase fw-bold text-muted">Total Inventory</small>
                <h2 class="fw-bold text-dark mt-1">{{ total_items }}</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <small class="text-uppercase fw-bold text-muted">Active Bookings</small>
                <h2 class="fw-bold text-primary mt-1">{{ active_bookings }}</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <small class="text-uppercase fw-bold text-muted">Total Issues</small>
                <h2 class="fw-bold text-dark mt-1">{{ total_issues }}</h2>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4">
            <div class="chart-container">
                <h6 class="fw-bold text-uppercase text-muted mb-4">Issue Status Distribution</h6>
                <div id="issueChart"></div>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="chart-container">
                <h6 class="fw-bold text-uppercase text-muted mb-4">Top Item Categories</h6>
                <div id="categoryChart"></div>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="chart-container">
                <h6 class="fw-bold text-uppercase text-muted mb-4">Live Room Status</h6>
                <div id="roomChart"></div>
            </div>
        </div>
    </div>

    <h5 class="fw-bold mb-4 mt-2">Command Operations</h5>
    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="manager-card" data-bs-toggle="modal" data-bs-target="#reportModal">
                <i class="bi bi-file-earmark-spreadsheet-fill text-primary"></i>
                <h5 class="fw-bold">Report Generator</h5>
                <p class="small opacity-75 mb-0">Cross-module data extraction & filtering</p>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="manager-card" data-bs-toggle="modal" data-bs-target="#dataManagerModal" onclick="loadAuraData()">
                <i class="bi bi-shield-lock-fill text-warning"></i>
                <h5 class="fw-bold">Data Manager</h5>
                <p class="small opacity-75 mb-0">Advanced Record Access & System Purge</p>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="manager-card" data-bs-toggle="modal" data-bs-target="#bookingManagerModal" onclick="loadBookingData()">
                <i class="bi bi-calendar-event-fill text-success"></i>
                <h5 class="fw-bold">Room Booking Manager</h5>
                <p class="small opacity-75 mb-0">Real-time Scheduling & Booking Control</p>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="dataManagerModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold"><i class="bi bi-database me-2"></i>AURA Data Manager</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="d-flex align-items-center gap-3 w-50">
                        <label class="small fw-bold text-muted">SELECT MODULE</label>
                        <select class="form-select w-50" id="modelSelector" onchange="loadAuraData()">
                            <option value="issues">Issues</option>
                            <option value="items">Inventory Items</option>
                            <option value="rooms">Rooms</option>
                            <option value="purchases">Purchases</option>
                        </select>
                        <button id="bulkDeleteBtn" class="btn btn-danger btn-sm d-none" onclick="bulkDeleteRecords()">
                            <i class="bi bi-trash3-fill me-1"></i> Bulk Delete
                        </button>
                    </div>
                    <div class="text-end">
                        <small class="text-muted" id="recordCount">Loading records...</small>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)"></th>
                                <th>ID</th><th>Main Label</th><th>Details / Status</th><th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="auraDataBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold"><i class="bi bi-file-earmark-bar-graph me-2"></i>AURA Report Engine</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3 mb-4 p-3 bg-light rounded-3">
                    <div class="col-md-4">
                        <label class="form-label small fw-bold">MODULE</label>
                        <select class="form-select" id="reportModule">
                            <option value="rooms">Rooms</option>
                            <option value="bookings">Room Bookings</option>
                            <option value="issues">Issues Tracking</option>
                            <option value="items">Inventory/Assets</option>
                            <option value="purchases">Purchases</option>
                            <option value="vendors">Vendors</option>
                            <option value="departments">Departments</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">DATE FROM</label>
                        <input type="date" class="form-control" id="dateFrom">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">DATE TO</label>
                        <input type="date" class="form-control" id="dateTo">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-primary w-100" onclick="generateAuraReport()">GENERATE</button>
                    </div>
                </div>
                <div id="reportContainer" style="display:none;">
                    <div class="d-flex justify-content-between mb-2">
                        <h6 class="fw-bold">Report Results</h6>
                        <button class="btn btn-sm btn-outline-danger" onclick="downloadAuraPDF()">
                            <i class="bi bi-file-earmark-pdf me-1"></i> Download PDF
                        </button>
                    </div>
                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-bordered report-table">
                            <thead id="reportHead"></thead>
                            <tbody id="reportContent"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="bookingManagerModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold"><i class="bi bi-calendar-check me-2"></i>Room Booking Control</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="bookingTableContainer" class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Room</th><th>Faculty</th><th>Email</th><th>Schedule (Start - End)</th><th>Status</th><th>Control</th>
                            </tr>
                        </thead>
                        <tbody id="bookingDataBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
    // 1. Live Charts Logic
    document.addEventListener('DOMContentLoaded', function() {
        fetch('{% url "central_admin:aura_api_analytics" %}')
            .then(res => res.json())
            .then(data => {
                // Issues Chart
                new ApexCharts(document.querySelector("#issueChart"), {
                    series: data.issue_series,
                    chart: { type: 'donut', height: 320 },
                    labels: data.issue_labels,
                    colors: ['#3b82f6', '#ef4444', '#f59e0b', '#10b981'],
                    legend: { position: 'bottom' }
                }).render();

                // Category Bar Chart
                new ApexCharts(document.querySelector("#categoryChart"), {
                    series: [{ name: 'Items', data: data.cat_series }],
                    chart: { type: 'bar', height: 320, toolbar: { show: false } },
                    plotOptions: { bar: { borderRadius: 8, horizontal: true, barHeight: '60%' } },
                    colors: ['#3b82f6'],
                    xaxis: { categories: data.cat_labels }
                }).render();

                // Room Utilization Pie
                new ApexCharts(document.querySelector("#roomChart"), {
                    series: data.room_util,
                    chart: { type: 'pie', height: 300 },
                    labels: ['Occupied Today', 'Available'],
                    colors: ['#0f172a', '#3b82f6'],
                    legend: { position: 'bottom' }
                }).render();
            });
    });

    // 2. Data Manager Logic
    function loadAuraData() {
        const model = document.getElementById('modelSelector').value;
        const body = document.getElementById('auraDataBody');
        const selectAllCb = document.getElementById('selectAll');

        document.getElementById('selectAll').checked = false;
        document.getElementById('bulkDeleteBtn').classList.add('d-none');
        body.innerHTML = '<tr><td colspan="5" class="text-center py-5"><div class="spinner-border text-primary"></div></td></tr>';

        fetch(`{% url "central_admin:aura_api_data" %}?model=${model}`)
            .then(res => res.json())
            .then(data => {
                body.innerHTML = '';
                document.getElementById('recordCount').innerText = `${data.results.length} records found`;
                data.results.forEach(row => {
                    body.innerHTML += `
                        <tr>
                            <td><input type="checkbox" class="record-checkbox" value="${row.id}" onchange="updateBulkDeleteButton()"></td>
                            <td class="text-muted">#${row.id}</td>
                            <td class="fw-bold">${row.label}</td>
                            <td><span class="badge bg-light text-dark border">${row.detail || 'N/A'}</span></td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteRecord('${model}', ${row.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            });
    }

    // 3. Report Engine Logic
    function generateAuraReport() {
        const module = document.getElementById('reportModule').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        const container = document.getElementById('reportContainer');
        const head = document.getElementById('reportHead');
        const content = document.getElementById('reportContent');

        // Loading State
        container.style.display = 'block';
        content.innerHTML = '<tr><td colspan="3" class="text-center py-5"><div class="spinner-border text-primary me-2"></div>Records loading...</td></tr>';
        head.innerHTML = '<tr><th>ID</th><th>Primary Record</th><th>Full Metadata/Details</th></tr>';

        fetch(`{% url "central_admin:aura_api_data" %}?model=${module}&date_from=${dateFrom}&date_to=${dateTo}`)
            .then(res => res.json())
            .then(data => {
                content.innerHTML = '';
                if (!data.results || data.results.length === 0) {
                    content.innerHTML = '<tr><td colspan="3" class="text-center py-5 text-muted">No records found for the selected criteria.</td></tr>';
                    return;
                }
                data.results.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row.id}</td>
                        <td class="fw-bold">${row.label}</td>
                        <td>${row.detail || '---'}</td>
                    `;
                    content.appendChild(tr);
                });
            })
            .catch(err => {
                content.innerHTML = '<tr><td colspan="3" class="text-center py-5 text-danger">Error connecting to AURA system.</td></tr>';
            });
    }

    // 4. Room Booking Manager Logic
    function loadBookingData() {
        const body = document.getElementById('bookingDataBody');
        body.innerHTML = '<tr><td colspan="6" class="text-center">Synchronizing Schedules...</td></tr>';
        
        fetch(`{% url "central_admin:aura_api_data" %}?model=bookings`)
            .then(res => res.json())
            .then(data => {
                body.innerHTML = '';
                if (data.results.length === 0) {
                    body.innerHTML = '<tr><td colspan="6" class="text-center">No bookings found.</td></tr>';
                    return;
                }
                data.results.forEach(row => {
                    // Split the updated label to get Room Name and Faculty Email
                    const labelParts = row.label.split('|');
                    const roomName = labelParts[0].trim();
                    const facultyEmail = labelParts[1] ? labelParts[1].trim() : '---';
                    const facultyName = row.detail;
                    const scheduleTime = row.schedule || '---';
                    
                    body.innerHTML += `
                        <tr>
                            <td class="fw-bold text-primary">${roomName}</td>
                            <td>${facultyName}</td>
                            <td><small class="text-muted">${facultyEmail}</small></td>
                            <td class="fw-semibold">${scheduleTime}</td>
                            <td><span class="badge bg-success">Active</span></td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteRecord('bookings', ${row.id})">Cancel</button>
                            </td>
                        </tr>
                    `;
                });
            });
    }

    // 5. Global Delete (Restricted to Central Admin Backend)
    function deleteRecord(model, id) {
        if(confirm('CRITICAL ACTION: Purge this record from AURA database? This cannot be undone.')) {
            fetch('{% url "central_admin:aura_api_delete" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ model: model, id: id })
            }).then(res => {
                if(res.ok) {
                    if(model === 'bookings') loadBookingData();
                    else loadAuraData();
                }
            });
        }
    }

    // 7. Optimized Backend PDF Download Logic
    function downloadAuraPDF() {
        const moduleName = document.getElementById('reportModule').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        const content = document.getElementById('reportContent');
        
        // Validation: Ensure there is at least something to download
        if (!content || content.children.length === 0 || content.innerText.includes('Records loading')) {
            alert("Please generate the report results in the table first to verify data exists.");
            return;
        }

        // Redirect to the backend PDF view with existing filters
        const baseUrl = '{% url "central_admin:aura_api_pdf" %}';   
        const downloadUrl = `${baseUrl}?model=${moduleName}&date_from=${dateFrom}&date_to=${dateTo}`;
        
        // Open in new tab to trigger download
        window.open(downloadUrl, '_blank');
    }

    // 8. Toggle all checkboxes and show/hide bulk delete button
    function toggleSelectAll(masterCheckbox) {
        const checkboxes = document.querySelectorAll('.record-checkbox');
        checkboxes.forEach(cb => cb.checked = masterCheckbox.checked);
        updateBulkDeleteButton();
    }

    function updateBulkDeleteButton() {
        const selectedCount = document.querySelectorAll('.record-checkbox:checked').length;
        const btn = document.getElementById('bulkDeleteBtn');
        if (selectedCount > 0) btn.classList.remove('d-none');
        else btn.classList.add('d-none');
    }

    // 9. New Bulk Delete Logic
    function bulkDeleteRecords() {
        const model = document.getElementById('modelSelector').value;
        const selectedIds = Array.from(document.querySelectorAll('.record-checkbox:checked')).map(cb => cb.value);
        
        if (confirm(`MASS PURGE: Are you sure you want to delete ${selectedIds.length} records? This action is permanent.`)) {
            fetch('{% url "central_admin:aura_api_bulk_delete" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ model: model, ids: selectedIds })
            }).then(res => {
                if (res.ok) {
                    loadAuraData();
                    alert('Records purged successfully.');
                }
            });
        }
    }
</script>
{% endblock content %}