{% extends "sidebar_base.html" %}
{% load static %}

{% block title %} | AURA Command Center{% endblock title %}

{% block style %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<style>
    :root { --aura-primary: #3b82f6; --aura-dark: #0f172a; --aura-accent: #10b981; }
    body { background-color: #f8fafc; }
    .aura-header { margin-bottom: 2rem; }
    .stat-card {
        background: white; border: none; border-radius: 15px;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 20px;
        transition: 0.3s;
    }
    .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    .chart-container { background: white; border-radius: 20px; padding: 20px; margin-bottom: 45px; border: 1px solid #e2e8f0; }
    .manager-card {
        background: white; border: 1px solid #e2e8f0; border-radius: 20px; cursor: pointer;
        padding: 30px; text-align: center; transition: all 0.3s ease;height: 100%; 
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    .row-equal-height > [class*='col-'] {
        display: flex;
        flex-direction: column;
    }
    .manager-card:hover { 
        background: var(--aura-primary); color: white !important; 
        transform: scale(1.02); box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.2);
    }
    .manager-card i { font-size: 2.5rem; margin-bottom: 15px; display: block; }
    
    /* Modal Customization */
    .modal-content { border-radius: 20px; border: none; }
    .modal-header { background: var(--aura-dark); color: white; border-radius: 20px 20px 0 0; padding: 1.5rem; }
    .btn-close-white { filter: invert(1) grayscale(100%) brightness(200%); }
    .report-table thead { position: sticky; top: 0; background: var(--aura-dark); color: white; }
    .table-responsive {
        overflow: auto !important;
    }
    /* Faculty table sticky header needs overflow auto, not visible */
    #credTable thead th { position: sticky; top: 0; z-index: 2; }
    .cred-checkbox { cursor: pointer; width: 16px; height: 16px; }
    
    #reportContainer table {
        width: 100% !important;
        background-color: white !important;
    }
    
    .hover-card {
    transition: all 0.3s ease;
    }

    .hover-card:hover {
    background-color: #f8fafc;
    transform: translateY(-5px);
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    }

</style>
{% endblock style %}

{% block content %}
<div class="container-fluid py-4">
    <div class="aura-header d-flex justify-content-between align-items-center">
        <div>
            <a href="{% url 'central_admin:dashboard' %}" class="btn btn-sm btn-outline-secondary mb-3 rounded-pill px-3">
                <i class="bi bi-arrow-left me-1"></i> Dashboard
            </a>
            <h1 class="fw-bold text-dark mb-0">AURA <span class="text-primary">Command</span></h1>
            <p class="text-muted mb-0">Admin Unified Report & Analysis System</p>
        </div>
        <div class="text-end d-flex align-items-center gap-3 justify-content-end">
            <span class="badge bg-primary px-3 py-2 rounded-pill"><i class="bi bi-broadcast me-1"></i> LIVE SYSTEM DATA</span>
            <!-- ‚îÄ‚îÄ Admin Notification Bell ‚îÄ‚îÄ -->
            <a href="{% url 'central_admin:admin_notifications' %}"
               class="position-relative text-decoration-none" id="adminBellLink" title="Notifications">
                <div style="width:42px;height:42px;background:#fff;border:1.5px solid #e2e8f0;
                            border-radius:12px;display:flex;align-items:center;justify-content:center;
                            box-shadow:0 2px 6px rgba(0,0,0,0.06);transition:background 0.18s;"
                     onmouseover="this.style.background='#f1f5f9'"
                     onmouseout="this.style.background='#fff'">
                    <i class="bi bi-bell-fill" style="font-size:1.1rem;color:#6366f1;"></i>
                </div>
                <span id="adminBellBadge"
                      style="display:none;position:absolute;top:-7px;right:-7px;
                             background:#ef4444;color:#fff;border-radius:999px;
                             font-size:0.62rem;font-weight:800;padding:2px 5px;
                             min-width:18px;text-align:center;line-height:1.5;
                             border:2px solid #fff;pointer-events:none;">0</span>
            </a>
        </div>
    </div>

    <div class="row mb-4 text-center">
        <div class="col-md-3">
            <div class="stat-card">
                <small class="text-uppercase fw-bold text-muted">Escalated Issues</small>
                <h2 class="fw-bold text-danger mt-1">{{ escalated_count }}</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <small class="text-uppercase fw-bold text-muted">Total Inventory</small>
                <h2 class="fw-bold text-dark mt-1">{{ total_items }}</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <small class="text-uppercase fw-bold text-muted">Confirmed Bookings</small>
                <h2 class="fw-bold text-primary mt-1">{{ active_bookings }}</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <small class="text-uppercase fw-bold text-muted">Total Issues</small>
                <h2 class="fw-bold text-dark mt-1">{{ total_issues }}</h2>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4">
            <div class="chart-container">
                <h6 class="fw-bold text-uppercase text-muted mb-4">Issue Status Distribution</h6>
                <div id="issueChart"></div>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="chart-container">
                <h6 class="fw-bold text-uppercase text-muted mb-4">Top Item Categories</h6>
                <div id="categoryChart"></div>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="chart-container">
                <h6 class="fw-bold text-uppercase text-muted mb-4">Live Room Status</h6>
                <div id="roomChart"></div>
            </div>
        </div>
    </div>

    <h5 class="fw-bold mb-4 mt-2">Command Operations</h5>
    <div class="row row-equal-height">
        <div class="col-md-4 mb-4">
            <div class="manager-card" data-bs-toggle="modal" data-bs-target="#reportModal">
                <i class="bi bi-file-earmark-spreadsheet-fill text-primary"></i>
                <h5 class="fw-bold">Report Generator</h5>
                <p class="small opacity-75 mb-0">Cross-module data extraction & filtering</p>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="manager-card" data-bs-toggle="modal" data-bs-target="#dataManagerModal" onclick="loadAuraData()">
                <i class="bi bi-shield-lock-fill text-warning"></i>
                <h5 class="fw-bold">Data Manager</h5>
                <p class="small opacity-75 mb-0">Advanced Record Access & System Purge</p>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="manager-card" data-bs-toggle="modal" data-bs-target="#bookingManagerModal" onclick="loadBookingData()">
                <i class="bi bi-calendar-event-fill text-success"></i>
                <h5 class="fw-bold">Room Booking Manager</h5>
                <p class="small opacity-75 mb-0">Confirmed Bookings &amp; Schedule Control</p>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="manager-card" data-bs-toggle="modal" data-bs-target="#facultyManagerModal" onclick="loadFacultyCredentials()">
                <i class="bi bi-person-check-fill text-info"></i>
                <h5 class="fw-bold">Faculty Manager</h5>
                <p class="small opacity-75 mb-0">Manage Booking Credentials</p>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="manager-card" data-bs-toggle="modal" data-bs-target="#bookingFilesModal" onclick="loadBookingFiles()">
                <i class="bi bi-file-earmark-text-fill text-danger"></i>
                <h5 class="fw-bold">Confirmed Booking Files</h5>
                <p class="small opacity-75 mb-0">View purposes &amp; attachments from approved bookings</p>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="manager-card" data-bs-toggle="modal" data-bs-target="#masterInventoryModal">
                <i class="bi bi-box-seam-fill" style="color: #9333ea;"></i>
                <h5 class="fw-bold">Master Inventory</h5>
                <p class="small opacity-75 mb-0">Master inventory stock</p>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="dataManagerModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold"><i class="bi bi-database me-2"></i>AURA Data Manager</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="d-flex align-items-center gap-3 w-50">
                        <label class="small fw-bold text-muted">SELECT MODULE</label>
                        <select class="form-select w-50" id="modelSelector" onchange="loadAuraData()">
                            <option value="issues">Issues</option>
                            <option value="items">Inventory Items</option>
                            <option value="rooms">Rooms</option>
                            <option value="purchases">Purchases</option>
                        </select>
                        {% if request.user.profile.is_central_admin and not request.user.profile.is_sub_admin %}
                        <button id="bulkDeleteBtn" class="btn btn-danger btn-sm d-none" onclick="bulkDeleteRecords()">
                            <i class="bi bi-trash3-fill me-1"></i> Bulk Delete
                        </button>
                        {% endif %}
                    </div>
                    <div class="text-end">
                        <small class="text-muted" id="recordCount">Loading records...</small>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                       
                        <thead class="table-light">
                            <tr>
                                {% if request.user.profile.is_central_admin and not request.user.profile.is_sub_admin %}
                                <th style="width: 40px;"><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)"></th>
                                {% endif %}
                                <th>ID</th><th>Main Label</th><th>Details / Status</th><th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="auraDataBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold"><i class="bi bi-file-earmark-bar-graph me-2"></i>AURA Report Engine</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3 mb-4 p-3 bg-light rounded-3">
                    <div class="col-md-4">
                        <label class="form-label small fw-bold">MODULE</label>
                        <select class="form-select" id="reportModule">
                            <option value="rooms">Rooms</option>
                            <option value="bookings">Room Bookings</option>
                            <option value="issues">Issues Tracking</option>
                            <option value="items">Inventory/Assets</option>
                            <option value="purchases">Purchases</option>
                            <option value="vendors">Vendors</option>
                            <option value="departments">Departments</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">DATE FROM</label>
                        <input type="date" class="form-control" id="dateFrom">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">DATE TO</label>
                        <input type="date" class="form-control" id="dateTo">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-primary w-100" onclick="generateAuraReport()">GENERATE</button>
                    </div>
                </div>
                <div id="reportContainer" style="display:none;">
                    <div class="d-flex justify-content-between mb-2">
                        <h6 class="fw-bold">Report Results</h6>
                        <div>
                            <button class="btn btn-sm btn-outline-success me-2" onclick="downloadAuraExcel()">
                                <i class="bi bi-file-earmark-excel me-1"></i> Download Excel
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="downloadAuraPDF()">
                                <i class="bi bi-file-earmark-pdf me-1"></i> Download PDF
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-bordered report-table">
                            <thead id="reportHead"></thead>
                            <tbody id="reportContent"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="bookingManagerModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold"><i class="bi bi-calendar-check me-2"></i>Room Booking Control</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="bookingTableContainer" class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Room</th><th>Faculty</th><th>Email</th><th>Schedule (Start - End)</th><th>Status</th><th>Control</th>
                            </tr>
                        </thead>
                        <tbody id="bookingDataBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Master Inventory Modal -->
<div class="modal fade" id="masterInventoryModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold"><i class="bi bi-box-seam me-2"></i>Master Inventory Management</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-5">
                <div class="row g-3">
                    <div class="col-6">
                        <div class="p-4 border rounded-3 h-100 hover-card" style="cursor: pointer;" onclick="window.location.href='{% url 'central_admin:master_inventory_import' %}'">
                            <i class="bi bi-file-earmark-spreadsheet-fill text-success" style="font-size: 3rem;"></i>
                            <h6 class="fw-bold mt-3 mb-1">Import Excel</h6>
                            <p class="small text-muted mb-0">Bulk upload items from spreadsheet</p>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-4 border rounded-3 h-100 hover-card" style="cursor: pointer;" onclick="window.location.href='{% url 'central_admin:master_inventory_list' %}'">
                            <i class="bi bi-table text-primary" style="font-size: 3rem;"></i>
                            <h6 class="fw-bold mt-3 mb-1">View Master Inventory</h6>
                            <p class="small text-muted mb-0">See all items & assign to rooms</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- ‚ïê‚ïê CONFIRMED BOOKING FILES MODAL ‚ïê‚ïê -->
<div class="modal fade" id="bookingFilesModal" tabindex="-1"
     data-booking-files-url="{% url 'central_admin:confirmed_booking_files' %}"
     data-doc-text-url="{% url 'central_admin:get_booking_doc_text' booking_id=0 %}"
     data-doc-pdf-url="{% url 'central_admin:download_booking_doc_as_pdf' booking_id=0 %}"
     data-delete-url="{% url 'central_admin:delete_confirmed_booking' booking_id=0 %}"
     data-bulk-delete-url="{% url 'central_admin:bulk_delete_confirmed_bookings' %}"
     data-is-central-admin="{{ request.user.profile.is_central_admin|yesno:'true,false' }}">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold"><i class="bi bi-file-earmark-text me-2"></i>Confirmed Booking Files</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small mb-2">All confirmed (admin-approved) bookings are listed here, including their purpose and any attached documents.</p>

                <!-- Bulk-action toolbar ‚Äî only rendered/visible for central admins via JS -->
                <div id="bfcBulkToolbar" style="display:none;background:#fef3c7;border:1px solid #fbbf24;border-radius:12px;padding:10px 16px;margin-bottom:14px;align-items:center;gap:12px;flex-wrap:wrap;">
                    <label style="display:flex;align-items:center;gap:8px;font-weight:700;font-size:0.85rem;color:#92400e;cursor:pointer;margin:0;">
                        <input type="checkbox" id="bfcSelectAll" style="width:16px;height:16px;cursor:pointer;accent-color:#dc2626;">
                        <span id="bfcSelectAllLabel">Select All</span>
                    </label>
                    <span id="bfcSelectedCount" style="font-size:0.82rem;color:#78350f;background:#fde68a;border-radius:20px;padding:2px 12px;font-weight:600;display:none;">0 selected</span>
                    <button id="bfcBulkDeleteBtn" onclick="confirmBulkDelete()"
                            style="display:none;background:linear-gradient(135deg,#dc2626,#b91c1c);color:#fff;border:none;border-radius:10px;padding:7px 18px;font-weight:700;font-size:0.82rem;cursor:pointer;transition:opacity 0.2s;display:none;align-items:center;gap:6px;">
                        <i class="bi bi-trash3-fill"></i> Delete Selected
                    </button>
                </div>

                <div id="bookingFilesBody">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary"></div>
                        <p class="mt-2 text-muted">Loading confirmed bookings...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- File Detail Popup (in-page overlay) -->
<div id="fileDetailOverlay" style="display:none;position:fixed;inset:0;z-index:2000;background:rgba(15,23,42,0.65);backdrop-filter:blur(6px);align-items:center;justify-content:center;padding:20px;">
    <div id="fileDetailBox" style="background:#fff;border-radius:24px;padding:40px;max-width:560px;width:100%;position:relative;box-shadow:0 30px 60px -10px rgba(0,0,0,0.3);animation:fdSlideUp 0.3s ease;">
        <button onclick="closeFileDetail()" style="position:absolute;top:16px;right:18px;background:none;border:none;font-size:1.4rem;cursor:pointer;color:#94a3b8;">&#x2715;</button>
        <div id="fileDetailContent"></div>
    </div>
</div>
<style>
    @keyframes fdSlideUp { from { transform:translateY(28px);opacity:0; } to { transform:translateY(0);opacity:1; } }
    #fileDetailOverlay.open { display:flex; }
    .booking-file-card { background:#fff; border:1px solid #e2e8f0; border-radius:16px; padding:20px 24px; margin-bottom:14px; display:flex; align-items:flex-start; gap:16px; transition:box-shadow 0.2s; }
    .booking-file-card:hover { box-shadow: 0 8px 24px rgba(0,0,0,0.07); }
    .bfc-icon { width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,#6366f1,#a855f7);display:flex;align-items:center;justify-content:center;flex-shrink:0; }
    .bfc-icon i { color:#fff;font-size:1.4rem; }
    .bfc-body { flex:1; }
    .bfc-room { font-weight:800;color:#1e293b;font-size:1rem;margin-bottom:4px; }
    .bfc-meta { font-size:0.82rem;color:#64748b;margin-bottom:6px; }
    .bfc-purpose { font-size:0.85rem;color:#475569;background:#f8fafc;border-radius:8px;padding:8px 12px;border-left:3px solid #6366f1;margin-bottom:8px; white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:400px; }
    .bfc-actions { display:flex;gap:8px; }
    .btn-view-file { background:linear-gradient(135deg,#6366f1,#9333ea);color:#fff;border:none;border-radius:10px;padding:7px 18px;font-weight:700;font-size:0.82rem;cursor:pointer;transition:opacity 0.2s; }
    .btn-view-file:hover { opacity:0.85; }
    .btn-dl-file { background:#f1f5f9;color:#475569;border:1px solid #e2e8f0;border-radius:10px;padding:7px 14px;font-weight:600;font-size:0.82rem;text-decoration:none;display:inline-flex;align-items:center;gap:5px;transition:background 0.2s; }
    .btn-dl-file:hover { background:#e2e8f0; color:#1e293b; }
    .doc-text-panel { display:none; margin-top:12px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:14px 16px; }
    .doc-text-panel.open { display:block; }
    .doc-text-content { font-size:0.82rem; color:#334155; line-height:1.65; max-height:300px; overflow-y:auto; }
    .doc-para { margin-bottom:6px; }
    .doc-table-wrap { overflow-x:auto; margin-bottom:10px; }
    .doc-table { width:100%; border-collapse:collapse; font-size:0.8rem; }
    .doc-table th { background:linear-gradient(135deg,#6366f1,#7c3aed); color:#fff; font-weight:700; padding:7px 10px; text-align:left; }
    .doc-table td { padding:6px 10px; border-bottom:1px solid #e2e8f0; color:#1e293b; }
    .doc-table tr:nth-child(even) td { background:#f0f4ff; }
    .doc-table tr:hover td { background:#e0e7ff; }
    .btn-dl-pdf { background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;border-radius:10px;padding:7px 14px;font-weight:700;font-size:0.82rem;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:5px;transition:opacity 0.2s; }
    .btn-dl-pdf:hover { opacity:0.85; color:#fff; }
    /* Delete button on each card */
    .btn-delete-booking { background:none;border:1px solid #fca5a5;color:#dc2626;border-radius:10px;padding:7px 14px;font-weight:600;font-size:0.82rem;cursor:pointer;transition:all 0.2s;display:inline-flex;align-items:center;gap:5px; }
    .btn-delete-booking:hover { background:#fee2e2;border-color:#dc2626; }
    /* Checkbox select state */
    .booking-file-card.bfc-selected { border-color:#6366f1;box-shadow:0 0 0 2px rgba(99,102,241,0.25);background:#f5f3ff; }
    .bfc-checkbox-wrap { display:flex;align-items:flex-start;padding-top:4px; }
    .bfc-checkbox { width:18px;height:18px;cursor:pointer;accent-color:#6366f1;flex-shrink:0; }
    /* Confirm delete modal */
    #bfcDeleteConfirmOverlay { display:none;position:fixed;inset:0;z-index:3000;background:rgba(15,23,42,0.7);backdrop-filter:blur(4px);align-items:center;justify-content:center;padding:20px; }
    #bfcDeleteConfirmOverlay.open { display:flex; }
    #bfcDeleteConfirmBox { background:#fff;border-radius:20px;padding:36px 32px;max-width:420px;width:100%;box-shadow:0 30px 60px rgba(0,0,0,0.25);animation:fdSlideUp 0.25s ease;text-align:center; }
</style>

<!-- ‚ïê‚ïê DELETE CONFIRMATION OVERLAY ‚ïê‚ïê -->
<div id="bfcDeleteConfirmOverlay">
    <div id="bfcDeleteConfirmBox">
        <div style="width:56px;height:56px;background:linear-gradient(135deg,#dc2626,#b91c1c);border-radius:16px;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;">
            <i class="bi bi-trash3-fill" style="color:#fff;font-size:1.5rem;"></i>
        </div>
        <h5 id="bfcConfirmTitle" style="font-weight:900;color:#1e293b;margin-bottom:8px;">Delete Booking?</h5>
        <p id="bfcConfirmMsg" style="color:#64748b;font-size:0.9rem;margin-bottom:24px;line-height:1.6;">This action cannot be undone.</p>
        <div style="display:flex;gap:12px;justify-content:center;">
            <button onclick="closeBfcConfirm()" style="background:#f1f5f9;color:#475569;border:1px solid #e2e8f0;border-radius:12px;padding:10px 28px;font-weight:700;font-size:0.9rem;cursor:pointer;">Cancel</button>
            <button id="bfcConfirmDeleteBtn" style="background:linear-gradient(135deg,#dc2626,#b91c1c);color:#fff;border:none;border-radius:12px;padding:10px 28px;font-weight:700;font-size:0.9rem;cursor:pointer;transition:opacity 0.2s;">
                <i class="bi bi-trash3-fill me-1"></i>Yes, Delete
            </button>
        </div>
    </div>
</div>

<!-- room booking faculty manager -->
<div class="modal fade" id="facultyManagerModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold"><i class="bi bi-person-badge me-2"></i>Faculty Booking Credentials</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">

                <!-- Central Admin: Import + Bulk Delete toolbar -->
                {% if not request.user.userprofile.is_sub_admin %}
                <div class="d-flex justify-content-between align-items-center mb-3 bg-light p-3 rounded-3">
                    <div>
                        <h6 class="fw-bold mb-0">Authorization Control</h6>
                        <p class="text-muted small mb-0">Import Excel with columns: <code>email, designation, password</code></p>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        <form id="importCredForm" action="{% url 'core:import_booking_credentials' %}" method="POST" enctype="multipart/form-data" class="d-flex gap-2 align-items-center">
                            {% csrf_token %}
                            <label class="btn btn-outline-secondary btn-sm mb-0" style="cursor:pointer;">
                                <i class="bi bi-file-earmark-excel me-1"></i>
                                <span id="credFileName">Choose Excel File</span>
                                <input type="file" name="excel_file" id="credExcelFile" accept=".xlsx,.xls" style="display:none;" onchange="updateCredFileName(this)" required>
                            </label>
                            <button type="submit" id="importCredBtn" class="btn btn-primary btn-sm px-3" disabled>
                                <i class="bi bi-upload me-1"></i> Import
                            </button>
                        </form>
                        <button class="btn btn-danger btn-sm" onclick="bulkDeleteCreds()">
                            <i class="bi bi-trash me-1"></i> Bulk Delete
                        </button>
                    </div>
                </div>
                {% else %}
                <div class="mb-3 bg-light p-3 rounded-3">
                    <h6 class="fw-bold mb-0">Authorization Control</h6>
                    <p class="text-muted small mb-0">View-only access ‚Äî contact Central Admin to make changes.</p>
                </div>
                {% endif %}

                <!-- Alert -->
                <div id="facultyImportAlert" class="d-none mb-3"></div>

                <!-- Summary bar -->
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted" id="credCount"></small>
                    <input type="text" id="credSearch" class="form-control form-control-sm w-25"
                           placeholder="üîç  Search email..." oninput="filterCredTable()">
                </div>

                <div class="table-responsive" style="max-height:420px; overflow-y:auto;">
                    <table class="table table-hover align-middle mb-0" id="credTable">
                        <thead class="table-dark" style="position:sticky;top:0;z-index:1;">
                            <tr>
                                {% if not request.user.userprofile.is_sub_admin %}
                                <th style="width:36px;"><input type="checkbox" id="selectAllCreds"></th>
                                {% endif %}
                                <th>Email</th>
                                <th>Designation</th>
                                <th>Password</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="facultyCredBody">
                            <tr><td colspan="5" class="text-center py-4">
                                <div class="spinner-border spinner-border-sm text-primary me-2"></div>Loading...
                            </td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Credential Modal (Central Admin only) -->
<div class="modal fade" id="editCredModal" tabindex="-1" style="z-index:1060;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background:#0f172a; color:white; border-radius:20px 20px 0 0;">
                <h6 class="modal-title fw-bold"><i class="bi bi-pencil-square me-2"></i>Edit Credential</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" id="editCredId">
                <div class="mb-3">
                    <label class="form-label fw-bold small text-muted">EMAIL</label>
                    <input type="email" id="editCredEmail" class="form-control" placeholder="faculty@sfscollege.in">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold small text-muted">DESIGNATION</label>
                    <input type="text" id="editCredDesignation" class="form-control" placeholder="e.g. Faculty, HOD">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold small text-muted">PASSWORD <span class="text-muted fw-normal">(leave blank to keep existing)</span></label>
                    <div class="input-group">
                        <input type="password" id="editCredPassword" class="form-control" placeholder="New password (optional)">
                        <button class="btn btn-outline-secondary" type="button" onclick="toggleEditPwd()">
                            <i class="bi bi-eye" id="editPwdIcon"></i>
                        </button>
                    </div>
                </div>
                <div id="editCredAlert" class="d-none"></div>
            </div>
            <div class="modal-footer border-0">
                <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary btn-sm px-4" onclick="saveCredEdit()">
                    <i class="bi bi-check2 me-1"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
    const IS_CENTRAL_ADMIN = {% if request.user.profile.is_central_admin and not request.user.profile.is_sub_admin %}true{% else %}false{% endif %};

    // 1. Live Charts Logic
    document.addEventListener('DOMContentLoaded', function() {
        fetch('{% url "central_admin:aura_api_analytics" %}')
            .then(res => {
                if (!res.ok) throw new Error('HTTP ' + res.status);
                return res.json();
            })
            .then(data => {
                // Issues Chart
                new ApexCharts(document.querySelector("#issueChart"), {
                    series: data.issue_series,
                    chart: { type: 'donut', height: 320 },
                    labels: data.issue_labels,
                    colors: ['#3b82f6', '#ef4444', '#f59e0b', '#10b981'],
                    legend: { position: 'bottom' }
                }).render();

                // Category Bar Chart
                new ApexCharts(document.querySelector("#categoryChart"), {
                    series: [{ name: 'Items', data: data.cat_series }],
                    chart: { type: 'bar', height: 320, toolbar: { show: false } },
                    plotOptions: { bar: { borderRadius: 8, horizontal: true, barHeight: '60%' } },
                    colors: ['#3b82f6'],
                    xaxis: { categories: data.cat_labels }
                }).render();

                // Room Utilization Pie
                new ApexCharts(document.querySelector("#roomChart"), {
                    series: data.room_util,
                    chart: { type: 'pie', height: 300 },
                    labels: ['Occupied Today', 'Available'],
                    colors: ['#0f172a', '#3b82f6'],
                    legend: { position: 'bottom' }
                }).render();
            })
            .catch(err => {
                console.warn('AURA analytics load failed:', err);
                ['issueChart','categoryChart','roomChart'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = '<div class="text-center text-muted py-4 small"><i class="bi bi-exclamation-circle me-1"></i>Chart data unavailable</div>';
                });
            });
    });

    // 2. Data Manager Logic
    function loadAuraData() {
    const model = document.getElementById('modelSelector').value;
    const body = document.getElementById('auraDataBody');
    const recordCount = document.getElementById('recordCount');

    const selectAllCheckbox = document.getElementById('selectAll');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');

    if (selectAllCheckbox) selectAllCheckbox.checked = false;
    if (bulkDeleteBtn) bulkDeleteBtn.classList.add('d-none');

    const colspan = IS_CENTRAL_ADMIN ? 5 : 4;
    body.innerHTML = `<tr><td colspan="${colspan}" class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="text-muted mt-2 mb-0">Loading records...</p>
    </td></tr>`;
    if (recordCount) recordCount.innerText = 'Loading...';

    fetch(`{% url "central_admin:aura_api_data" %}?model=${model}`)
        .then(res => {
            if (!res.ok) throw new Error('HTTP ' + res.status);
            return res.json();
        })
        .then(data => {
            if (data.error) throw new Error(data.error);
            body.innerHTML = '';
            const results = data.results || [];
            if (recordCount) recordCount.innerText = `${results.length} record${results.length !== 1 ? 's' : ''} found`;

            if (results.length === 0) {
                body.innerHTML = `<tr><td colspan="${colspan}" class="text-center py-5 text-muted">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>No records found for this module.
                </td></tr>`;
                return;
            }

            results.forEach(row => {
                const actionCell = IS_CENTRAL_ADMIN
                    ? `<button class="btn btn-sm btn-outline-danger" onclick="deleteRecord('${model}', ${row.id})">
                           <i class="bi bi-trash"></i>
                       </button>`
                    : `<span class="badge bg-secondary">View Only</span>`;

                const rowHTML = IS_CENTRAL_ADMIN
                    ? `<tr>
                           <td><input type="checkbox" class="record-checkbox" value="${row.id}" onchange="updateBulkDeleteButton()"></td>
                           <td class="text-muted">#${row.id}</td>
                           <td class="fw-bold">${row.label}</td>
                           <td><span class="badge bg-light text-dark border">${row.detail || 'N/A'}</span></td>
                           <td class="text-end">${actionCell}</td>
                       </tr>`
                    : `<tr>
                           <td class="text-muted">#${row.id}</td>
                           <td class="fw-bold">${row.label}</td>
                           <td><span class="badge bg-light text-dark border">${row.detail || 'N/A'}</span></td>
                           <td class="text-end">${actionCell}</td>
                       </tr>`;

                body.innerHTML += rowHTML;
            });
        })
        .catch(err => {
            if (recordCount) recordCount.innerText = 'Error loading records';
            body.innerHTML = `<tr><td colspan="${colspan}" class="text-center py-5 text-danger">
                <i class="bi bi-exclamation-triangle-fill fs-1 d-block mb-2"></i>
                Failed to load data. <button class="btn btn-sm btn-outline-danger mt-2" onclick="loadAuraData()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Retry
                </button>
            </td></tr>`;
        });
}

    // 3. Report Engine Logic
    function generateAuraReport() {
        const module = document.getElementById('reportModule').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        const container = document.getElementById('reportContainer');
        const head = document.getElementById('reportHead');
        const content = document.getElementById('reportContent');

        // Loading State
        container.style.display = 'block';
        head.innerHTML = '<tr><th>ID</th><th>Record</th><th>Details</th></tr>';
        content.innerHTML = '<tr><td colspan="3" class="text-center py-5"><div class="spinner-border text-primary me-2" role="status"></div><span class="text-muted">Loading records...</span></td></tr>';

        fetch(`{% url "central_admin:aura_api_data" %}?model=${module}&date_from=${dateFrom}&date_to=${dateTo}`)
            .then(res => {
                if (!res.ok) throw new Error('HTTP ' + res.status);
                return res.json();
            })
            .then(data => {
                if (data.error) throw new Error(data.error);
                content.innerHTML = '';
                const results = data.results || [];
                if (results.length === 0) {
                    head.innerHTML = '';
                    content.innerHTML = '<tr><td colspan="3" class="text-center py-5 text-muted"><i class="bi bi-inbox fs-1 d-block mb-2"></i>No records found for the selected criteria.</td></tr>';
                    return;
                }

                // Set dynamic headers based on the first result
                const first = results[0];
                head.innerHTML = `<tr><th>ID</th><th>${first.label_head || 'Record'}</th><th>${first.detail_head || 'Details'}</th></tr>`;

                results.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row.id}</td>
                        <td class="fw-bold">${row.label}</td>
                        <td>${row.detail || '---'}</td>
                    `;
                    content.appendChild(tr);
                });
            })
            .catch(err => {
                head.innerHTML = '';
                content.innerHTML = `<tr><td colspan="3" class="text-center py-5 text-danger">
                    <i class="bi bi-exclamation-triangle-fill fs-1 d-block mb-2"></i>
                    Error connecting to AURA system.
                    <button class="btn btn-sm btn-outline-danger mt-2 d-block mx-auto" onclick="generateAuraReport()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Retry
                    </button>
                </td></tr>`;
            });
    }

    // 4. Room Booking Manager Logic
    function loadBookingData() {
        const body = document.getElementById('bookingDataBody');
        body.innerHTML = '<tr><td colspan="6" class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="text-muted mt-2 mb-0">Synchronizing Schedules...</p></td></tr>';

        fetch(`{% url "central_admin:aura_api_data" %}?model=bookings`)
            .then(res => {
                if (!res.ok) throw new Error('HTTP ' + res.status);
                return res.json();
            })
            .then(data => {
                if (data.error) throw new Error(data.error);
                body.innerHTML = '';
                const results = data.results || [];
                if (results.length === 0) {
                    body.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-muted"><i class="bi bi-calendar-x fs-1 d-block mb-2"></i>No confirmed bookings found.</td></tr>';
                    return;
                }
                results.forEach(row => {
                body.innerHTML += `
                    <tr>
                        <td class="fw-bold text-primary">${row.room_name || 'N/A'}</td>
                        <td>${row.faculty_name || 'N/A'}</td>
                        <td><small class="text-muted">${row.faculty_email || 'N/A'}</small></td>
                        <td class="fw-semibold">${row.schedule || 'N/A'}</td>
                        <td><span class="badge bg-success">Active</span></td>

                        <td>
                            {% if request.user.profile.is_central_admin and not request.user.profile.is_sub_admin %}
                                <button class="btn btn-sm btn-danger" onclick="deleteRecord('bookings', ${row.id})">Cancel</button>
                            {% else %}
                                <span class="badge bg-secondary">View Only</span>
                            {% endif %}
                        </td>
                    </tr>
                `;
            });
        })
        .catch(err => {
            body.innerHTML = `<tr><td colspan="6" class="text-center py-5 text-danger">
                <i class="bi bi-exclamation-triangle-fill fs-1 d-block mb-2"></i>
                Failed to load booking data.
                <button class="btn btn-sm btn-outline-danger mt-2 d-block mx-auto" onclick="loadBookingData()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Retry
                </button>
            </td></tr>`;
        });
}

    // 5. Global Delete (Restricted to Central Admin Backend)
    function deleteRecord(model, id) {
        if(confirm('CRITICAL ACTION: Purge this record from AURA database? This cannot be undone.')) {
            fetch('{% url "central_admin:aura_api_delete" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ model: model, id: id })
            }).then(res => {
                if(res.ok) {
                    if(model === 'bookings') loadBookingData();
                    else loadAuraData();
                }
            });
        }
    }

    // 7. Optimized Backend PDF Download Logic
    function downloadAuraPDF() {
        const moduleName = document.getElementById('reportModule').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        const content = document.getElementById('reportContent');
        
        // Validation: Ensure there is at least something to download
        if (!content || content.children.length === 0 || content.innerText.includes('Records loading')) {
            alert("Please generate the report results in the table first to verify data exists.");
            return;
        }

        // Redirect to the backend PDF view with existing filters
        const baseUrl = '{% url "central_admin:aura_api_pdf" %}';   
        const downloadUrl = `${baseUrl}?model=${moduleName}&date_from=${dateFrom}&date_to=${dateTo}`;
        
        // Open in new tab to trigger download
        window.open(downloadUrl, '_blank');
    }

    // 8. Toggle all checkboxes and show/hide bulk delete button
    function toggleSelectAll(masterCheckbox) {
        const checkboxes = document.querySelectorAll('.record-checkbox');
        checkboxes.forEach(cb => cb.checked = masterCheckbox.checked);
        updateBulkDeleteButton();
    }

    function updateBulkDeleteButton() {
        const selectedCount = document.querySelectorAll('.record-checkbox:checked').length;
        const btn = document.getElementById('bulkDeleteBtn');
        if (selectedCount > 0) btn.classList.remove('d-none');
        else btn.classList.add('d-none');
    }

    // 9. New Bulk Delete Logic
    function bulkDeleteRecords() {
        const model = document.getElementById('modelSelector').value;
        const selectedIds = Array.from(document.querySelectorAll('.record-checkbox:checked')).map(cb => cb.value);
        
        if (confirm(`MASS PURGE: Are you sure you want to delete ${selectedIds.length} records? This action is permanent.`)) {
            fetch('{% url "central_admin:aura_api_bulk_delete" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ model: model, ids: selectedIds })
            }).then(res => {
                if (res.ok) {
                    loadAuraData();
                    alert('Records purged successfully.');
                }
            });
        }
    }


    // ‚îÄ‚îÄ FACULTY CREDENTIALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let allCredRows = [];   // cached for search filtering

    // File input label update
    function updateCredFileName(input) {
        const label = document.getElementById('credFileName');
        const btn   = document.getElementById('importCredBtn');
        if (input.files && input.files[0]) {
            label.textContent = input.files[0].name;
            btn.disabled = false;
        } else {
            label.textContent = 'Choose Excel File';
            btn.disabled = true;
        }
    }

    // Load / refresh credentials table
    function loadFacultyCredentials() {
        const body = document.getElementById('facultyCredBody');
        const colSpan = IS_CENTRAL_ADMIN ? 5 : 4;
        body.innerHTML = `<tr><td colspan="${colSpan}" class="text-center py-4"><div class="spinner-border spinner-border-sm text-primary me-2"></div>Loading...</td></tr>`;

        fetch(`{% url "central_admin:aura_api_data" %}?model=credentials`)
            .then(res => { if (!res.ok) throw new Error(res.status); return res.json(); })
            .then(data => {
                allCredRows = data.results || [];
                renderCredTable(allCredRows);
            })
            .catch(() => {
                const colSpan = IS_CENTRAL_ADMIN ? 5 : 4;
                body.innerHTML = `<tr><td colspan="${colSpan}" class="text-center py-4 text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>Failed to load credentials. Please try again.</td></tr>`;
            });
    }

    function renderCredTable(rows) {
        const body = document.getElementById('facultyCredBody');
        const colSpan = IS_CENTRAL_ADMIN ? 5 : 4;
        document.getElementById('credCount').textContent = `${rows.length} credential${rows.length !== 1 ? 's' : ''} found`;

        if (!rows.length) {
            body.innerHTML = `<tr><td colspan="${colSpan}" class="text-center py-5 text-muted">
                <i class="bi bi-person-x fs-2 d-block mb-2"></i>
                No faculty credentials found.${IS_CENTRAL_ADMIN ? ' Import an Excel file to get started.' : ''}
            </td></tr>`;
            return;
        }

        body.innerHTML = '';
        rows.forEach(row => {
            const maskedPwd = '‚óè'.repeat(Math.min((row.password || '').length, 10));
            const cbCell = IS_CENTRAL_ADMIN
                ? `<td><input type="checkbox" class="cred-checkbox form-check-input" value="${row.id}"></td>`
                : '';
            const actionCell = IS_CENTRAL_ADMIN
                ? `<td class="text-end">
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="openEditCred(${row.id},'${escHtml(row.email)}','${escHtml(row.designation)}')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSingleCred(${row.id}, this)">
                        <i class="bi bi-trash"></i>
                    </button>
                   </td>`
                : `<td class="text-end"><span class="badge bg-light text-muted border">View Only</span></td>`;

            const tr = document.createElement('tr');
            tr.dataset.credId = row.id;
            tr.innerHTML = `
                ${cbCell}
                <td class="fw-semibold">${escHtml(row.email)}</td>
                <td><span class="badge bg-light text-dark border px-2">${escHtml(row.designation)}</span></td>
                <td><code class="text-muted">${maskedPwd}</code>
                    ${IS_CENTRAL_ADMIN ? `<button class="btn btn-link btn-sm p-0 ms-2 text-muted" title="Reveal" onclick="revealPwd(this,'${escHtml(row.password || '')}')"><i class="bi bi-eye"></i></button>` : ''}
                </td>
                ${actionCell}
            `;
            body.appendChild(tr);
        });

        // Rebind select-all
        const sa = document.getElementById('selectAllCreds');
        if (sa) {
            sa.checked = false;
            sa.onchange = function() {
                document.querySelectorAll('.cred-checkbox').forEach(cb => cb.checked = this.checked);
            };
        }
    }

    // Search filter
    function filterCredTable() {
        const q = document.getElementById('credSearch').value.toLowerCase();
        const filtered = allCredRows.filter(r => r.email.toLowerCase().includes(q) || (r.designation || '').toLowerCase().includes(q));
        renderCredTable(filtered);
    }

    // Reveal password cell in-place
    function revealPwd(btn, pwd) {
        const cell = btn.closest('td');
        cell.innerHTML = `<code class="text-dark">${escHtml(pwd)}</code>
            <button class="btn btn-link btn-sm p-0 ms-2 text-muted" onclick="loadFacultyCredentials()"><i class="bi bi-eye-slash"></i></button>`;
    }

    // Open edit modal
    function openEditCred(id, email, designation) {
        document.getElementById('editCredId').value = id;
        document.getElementById('editCredEmail').value = email;
        document.getElementById('editCredDesignation').value = designation;
        document.getElementById('editCredPassword').value = '';
        document.getElementById('editCredAlert').className = 'd-none';
        new bootstrap.Modal(document.getElementById('editCredModal')).show();
    }

    // Save edited credential
    function saveCredEdit() {
        const id    = document.getElementById('editCredId').value;
        const email = document.getElementById('editCredEmail').value.trim();
        const desig = document.getElementById('editCredDesignation').value.trim();
        const pwd   = document.getElementById('editCredPassword').value.trim();
        const alert = document.getElementById('editCredAlert');

        if (!email) { showCredAlert(alert, 'danger', 'Email is required.'); return; }

        fetch(`/aura/credentials/${id}/update/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ email, designation: desig, password: pwd })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                bootstrap.Modal.getInstance(document.getElementById('editCredModal')).hide();
                loadFacultyCredentials();
            } else {
                showCredAlert(alert, 'danger', data.message || 'Update failed.');
            }
        })
        .catch(() => showCredAlert(alert, 'danger', 'Network error. Please try again.'));
    }

    // Delete single credential
    function deleteSingleCred(id, btn) {
        if (!confirm('Delete this credential? The faculty member will lose room booking access.')) return;
        btn.disabled = true;
        fetch(`/aura/credentials/${id}/delete/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                const row = btn.closest('tr');
                row.style.transition = 'opacity 0.3s';
                row.style.opacity = '0';
                setTimeout(() => { loadFacultyCredentials(); }, 300);
            } else {
                btn.disabled = false;
                alert('Delete failed: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(() => { btn.disabled = false; alert('Network error.'); });
    }

    // Bulk Delete Faculty Credentials
    function bulkDeleteCreds() {
        const selectedIds = Array.from(document.querySelectorAll('.cred-checkbox:checked')).map(cb => cb.value);
        if (!selectedIds.length) { alert('Please select at least one record.'); return; }

        if (confirm(`SECURITY ALERT: Revoke access for ${selectedIds.length} faculty member(s)? This cannot be undone.`)) {
            fetch('{% url "central_admin:aura_api_bulk_delete" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ model: 'credentials', ids: selectedIds })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') loadFacultyCredentials();
                else alert('Bulk delete failed: ' + (data.message || 'Unknown error'));
            });
        }
    }

    // AJAX Import ‚Äî keeps modal open, refreshes table on success
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('importCredForm');
        if (!form) return;

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const alertDiv = document.getElementById('facultyImportAlert');
            const btn = document.getElementById('importCredBtn');
            const formData = new FormData(form);

            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>';
            btn.disabled = true;

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(res => res.json().catch(() => ({ status: res.ok ? 'success' : 'error' })))
            .then(data => {
                if (data.status === 'success' || data.message === undefined) {
                    showCredAlert(alertDiv, 'success', `<i class="bi bi-check-circle-fill me-2"></i>${data.message || 'Credentials imported successfully!'}`);
                    form.reset();
                    document.getElementById('credFileName').textContent = 'Choose Excel File';
                    loadFacultyCredentials();
                } else {
                    showCredAlert(alertDiv, 'danger', `<i class="bi bi-exclamation-triangle-fill me-2"></i>${data.message || 'Import failed. Check your file format (columns: email, designation, password).'}`);
                }
            })
            .catch(() => {
                showCredAlert(alertDiv, 'danger', '<i class="bi bi-exclamation-triangle-fill me-2"></i>Import failed. Please check your file and try again.');
            })
            .finally(() => {
                btn.innerHTML = '<i class="bi bi-upload me-1"></i> Import';
                btn.disabled = false;
                setTimeout(() => alertDiv.className = 'd-none', 6000);
            });
        });
    });

    
    // Excel Download Logic
    function downloadAuraExcel() {
        const moduleName = document.getElementById('reportModule').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        const content = document.getElementById('reportContent');
    
        if (!content || content.children.length === 0 || content.innerText.includes('Records loading')) {
            alert("Please generate the report results first.");
            return;
        }

        const baseUrl = '{% url "central_admin:aura_api_excel" %}';   
        const downloadUrl = `${baseUrl}?model=${moduleName}&date_from=${dateFrom}&date_to=${dateTo}`;
        window.open(downloadUrl, '_blank');
    }

    // Toggle edit password visibility
    function toggleEditPwd() {
        const input = document.getElementById('editCredPassword');
        const icon  = document.getElementById('editPwdIcon');
        if (input.type === 'password') { input.type = 'text'; icon.className = 'bi bi-eye-slash'; }
        else { input.type = 'password'; icon.className = 'bi bi-eye'; }
    }

    // Helpers
    function showCredAlert(el, type, html) {
        el.className = `alert alert-${type} py-2 px-3 mb-0`;
        el.innerHTML = html;
    }
    function escHtml(str) {
        return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    // ‚îÄ‚îÄ Confirmed Booking Files ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // ‚îÄ‚îÄ Booking Files state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var _bfcIsCentralAdmin = false;
    var _bfcDeleteUrl      = null;
    var _bfcBulkDeleteUrl  = null;

    function loadBookingFiles() {
        const body    = document.getElementById('bookingFilesBody');
        const modal   = document.getElementById('bookingFilesModal');
        const fileUrl = modal ? modal.dataset.bookingFilesUrl : null;
        const docTextUrlTpl = modal ? modal.dataset.docTextUrl    : null;
        const docPdfUrlTpl  = modal ? modal.dataset.docPdfUrl     : null;

        // Capture central-admin flag and delete URLs from modal data attrs
        _bfcIsCentralAdmin = modal && modal.dataset.isCentralAdmin === 'true';
        _bfcDeleteUrl      = modal ? modal.dataset.deleteUrl      : null;
        _bfcBulkDeleteUrl  = modal ? modal.dataset.bulkDeleteUrl  : null;

        // Show / hide the bulk toolbar based on role
        const toolbar = document.getElementById('bfcBulkToolbar');
        if (toolbar) toolbar.style.display = _bfcIsCentralAdmin ? 'flex' : 'none';

        if (!fileUrl) {
            body.innerHTML = '<div class="text-center py-5 text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>Configuration error: booking files URL not found.</div>';
            return;
        }

        body.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-2 text-muted small">Loading confirmed bookings‚Ä¶</p></div>';

        fetch(fileUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(function(res) {
            if (!res.ok) throw new Error('HTTP ' + res.status);
            return res.json();
        })
        .then(function(data) {
            body.innerHTML = '';
            // Reset select-all
            const selectAll = document.getElementById('bfcSelectAll');
            if (selectAll) selectAll.checked = false;
            updateBfcSelectedCount();

            if (data.error) {
                body.innerHTML = `<div class="text-center py-5 text-danger"><i class="bi bi-lock me-2"></i>${escHtml(data.error)}</div>`;
                return;
            }
            if (!data.results || data.results.length === 0) {
                body.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-calendar-x fs-2 d-block mb-2 opacity-25"></i><p class="mb-0">No confirmed bookings found.</p></div>';
                return;
            }

            data.results.forEach(function(b) {
                // ‚îÄ‚îÄ Doc action buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                let docHtml = '';
                let docPanelHtml = '';
                if (b.has_doc_text) {
                    const textUrl = docTextUrlTpl ? docTextUrlTpl.replace('/0/', '/' + b.id + '/') : null;
                    const pdfUrl  = docPdfUrlTpl  ? docPdfUrlTpl.replace('/0/',  '/' + b.id + '/') : null;
                    docHtml = `
                        <button class="btn-view-file" onclick="toggleDocText(this, '${escHtml(textUrl)}')" data-booking-id="${b.id}">
                            <i class="bi bi-eye me-1"></i>View Doc
                        </button>
                        ${pdfUrl ? `<a href="${escHtml(pdfUrl)}" class="btn-dl-pdf"><i class="bi bi-file-earmark-pdf me-1"></i>Download PDF</a>` : ''}
                    `;
                    docPanelHtml = `
                        <div class="doc-text-panel" id="doc-panel-${b.id}">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                                <span style="font-weight:700;font-size:0.78rem;color:#6366f1;text-transform:uppercase;letter-spacing:0.5px;">
                                    <i class="bi bi-file-earmark-text me-1"></i>Document Content
                                </span>
                                <span class="text-muted" style="font-size:0.72rem;cursor:pointer;" onclick="closeDocPanel(${b.id})">‚úï Close</span>
                            </div>
                            <div class="doc-text-content" id="doc-text-${b.id}"></div>
                        </div>
                    `;
                } else {
                    docHtml = `<span class="text-muted small"><i class="bi bi-dash-circle me-1"></i>No document attached</span>`;
                }

                // ‚îÄ‚îÄ Delete button (central admin only) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const deleteBtn = _bfcIsCentralAdmin
                    ? `<button class="btn-delete-booking" onclick="confirmSingleDelete(${b.id}, '${escHtml(b.room)}', '${escHtml(b.faculty)}')">
                           <i class="bi bi-trash3"></i> Delete
                       </button>`
                    : '';

                const purposeHtml = b.purpose
                    ? `<div class="bfc-purpose" title="${escHtml(b.purpose)}"><i class="bi bi-chat-left-text me-1"></i>${escHtml(b.purpose)}</div>`
                    : `<div class="bfc-purpose text-muted fst-italic" style="opacity:0.6;"><i class="bi bi-dash-circle me-1"></i>No purpose specified</div>`;

                // ‚îÄ‚îÄ Checkbox (central admin only) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const checkboxHtml = _bfcIsCentralAdmin
                    ? `<div class="bfc-checkbox-wrap" style="margin-right:4px;">
                           <input type="checkbox" class="bfc-checkbox bfc-item-check" data-booking-id="${b.id}"
                                  onchange="onBfcCheckChange()">
                       </div>`
                    : '';

                const card = document.createElement('div');
                card.className = 'booking-file-card';
                card.dataset.bookingId = b.id;
                card.innerHTML = `
                    ${checkboxHtml}
                    <div class="bfc-icon"><i class="bi bi-building"></i></div>
                    <div class="bfc-body" style="width:100%;">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;">
                            <div class="bfc-room">${escHtml(b.room)}</div>
                            ${deleteBtn}
                        </div>
                        <div class="bfc-meta"><i class="bi bi-person me-1"></i>${escHtml(b.faculty)}</div>
                        <div class="bfc-meta"><i class="bi bi-envelope me-1"></i>${escHtml(b.email)}</div>
                        <div class="bfc-meta"><i class="bi bi-calendar3 me-1"></i>${escHtml(b.from)} &rarr; ${escHtml(b.to)}</div>
                        ${purposeHtml}
                        <div class="bfc-actions">${docHtml}</div>
                        ${docPanelHtml}
                    </div>
                `;
                body.appendChild(card);
            });
        })
        .catch(function(err) {
            console.error('Booking files error:', err);
            body.innerHTML = '<div class="text-center py-5 text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>Failed to load booking files. Please try again.</div>';
        });
    }

    // ‚îÄ‚îÄ Checkbox / selection helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function onBfcCheckChange() {
        updateBfcSelectedCount();
        // Sync select-all checkbox state
        const all  = document.querySelectorAll('.bfc-item-check');
        const chkd = document.querySelectorAll('.bfc-item-check:checked');
        const sa   = document.getElementById('bfcSelectAll');
        if (sa) sa.checked = all.length > 0 && chkd.length === all.length;
        // Highlight selected cards
        document.querySelectorAll('.booking-file-card').forEach(function(card) {
            const cb = card.querySelector('.bfc-item-check');
            if (cb) card.classList.toggle('bfc-selected', cb.checked);
        });
    }

    function updateBfcSelectedCount() {
        const chkd       = document.querySelectorAll('.bfc-item-check:checked');
        const countEl    = document.getElementById('bfcSelectedCount');
        const bulkBtn    = document.getElementById('bfcBulkDeleteBtn');
        const count      = chkd.length;
        if (countEl) {
            countEl.textContent = count + ' selected';
            countEl.style.display = count > 0 ? 'inline-block' : 'none';
        }
        if (bulkBtn) {
            bulkBtn.style.display = count > 0 ? 'inline-flex' : 'none';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const sa = document.getElementById('bfcSelectAll');
        if (sa) {
            sa.addEventListener('change', function() {
                document.querySelectorAll('.bfc-item-check').forEach(function(cb) {
                    cb.checked = sa.checked;
                });
                onBfcCheckChange();
            });
        }
    });

    // ‚îÄ‚îÄ Single delete ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var _bfcPendingDeleteId = null;

    function confirmSingleDelete(bookingId, room, faculty) {
        _bfcPendingDeleteId = bookingId;
        const title = document.getElementById('bfcConfirmTitle');
        const msg   = document.getElementById('bfcConfirmMsg');
        if (title) title.textContent = 'Delete Booking?';
        if (msg)   msg.innerHTML = `Are you sure you want to permanently delete the booking for <b>${escHtml(room)}</b> by <b>${escHtml(faculty)}</b>?<br><span style="color:#dc2626;font-size:0.82rem;font-weight:600;">This action cannot be undone.</span>`;
        const btn = document.getElementById('bfcConfirmDeleteBtn');
        if (btn) btn.onclick = function() { executeSingleDelete(bookingId); };
        document.getElementById('bfcDeleteConfirmOverlay').classList.add('open');
    }

    function executeSingleDelete(bookingId) {
        const btn = document.getElementById('bfcConfirmDeleteBtn');
        if (btn) { btn.disabled = true; btn.innerHTML = '<div class="spinner-border spinner-border-sm me-1"></div>Deleting‚Ä¶'; }

        const url = _bfcDeleteUrl ? _bfcDeleteUrl.replace('/0/', '/' + bookingId + '/') : null;
        if (!url) { closeBfcConfirm(); return; }

        fetch(url, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCsrfToken(), 'X-Requested-With': 'XMLHttpRequest' },
        })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            closeBfcConfirm();
            if (d.status === 'success') {
                // Remove card from DOM
                const card = document.querySelector(`.booking-file-card[data-booking-id="${bookingId}"]`);
                if (card) {
                    card.style.transition = 'opacity 0.3s,transform 0.3s';
                    card.style.opacity = '0';
                    card.style.transform = 'translateX(20px)';
                    setTimeout(function() { card.remove(); updateBfcSelectedCount(); }, 300);
                }
                showBfcToast(d.message || 'Booking deleted.', 'success');
            } else {
                showBfcToast(d.error || 'Delete failed.', 'error');
            }
        })
        .catch(function() { closeBfcConfirm(); showBfcToast('Delete failed. Please try again.', 'error'); });
    }

    // ‚îÄ‚îÄ Bulk delete ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function confirmBulkDelete() {
        const chkd = document.querySelectorAll('.bfc-item-check:checked');
        if (chkd.length === 0) return;
        const title = document.getElementById('bfcConfirmTitle');
        const msg   = document.getElementById('bfcConfirmMsg');
        if (title) title.textContent = `Delete ${chkd.length} Booking${chkd.length > 1 ? 's' : ''}?`;
        if (msg)   msg.innerHTML = `Are you sure you want to permanently delete <b>${chkd.length} booking${chkd.length > 1 ? 's' : ''}</b>?<br><span style="color:#dc2626;font-size:0.82rem;font-weight:600;">This action cannot be undone.</span>`;
        const btn = document.getElementById('bfcConfirmDeleteBtn');
        if (btn) btn.onclick = executeBulkDelete;
        document.getElementById('bfcDeleteConfirmOverlay').classList.add('open');
    }

    function executeBulkDelete() {
        const chkd = document.querySelectorAll('.bfc-item-check:checked');
        const ids  = Array.from(chkd).map(function(cb) { return parseInt(cb.dataset.bookingId); });
        if (!ids.length) return;

        const btn = document.getElementById('bfcConfirmDeleteBtn');
        if (btn) { btn.disabled = true; btn.innerHTML = '<div class="spinner-border spinner-border-sm me-1"></div>Deleting‚Ä¶'; }

        fetch(_bfcBulkDeleteUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify({ ids: ids }),
        })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            closeBfcConfirm();
            if (d.status === 'success') {
                ids.forEach(function(id) {
                    const card = document.querySelector(`.booking-file-card[data-booking-id="${id}"]`);
                    if (card) {
                        card.style.transition = 'opacity 0.3s,transform 0.3s';
                        card.style.opacity = '0';
                        card.style.transform = 'translateX(20px)';
                        setTimeout(function() { card.remove(); }, 300);
                    }
                });
                setTimeout(updateBfcSelectedCount, 350);
                showBfcToast(d.message || `${d.deleted_count} booking(s) deleted.`, 'success');
                // Reset select-all
                const sa = document.getElementById('bfcSelectAll');
                if (sa) sa.checked = false;
            } else {
                showBfcToast(d.error || 'Bulk delete failed.', 'error');
            }
        })
        .catch(function() { closeBfcConfirm(); showBfcToast('Bulk delete failed. Please try again.', 'error'); });
    }

    function closeBfcConfirm() {
        document.getElementById('bfcDeleteConfirmOverlay').classList.remove('open');
        const btn = document.getElementById('bfcConfirmDeleteBtn');
        if (btn) { btn.disabled = false; btn.innerHTML = '<i class="bi bi-trash3-fill me-1"></i>Yes, Delete'; }
    }

    // ‚îÄ‚îÄ Toast notification ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showBfcToast(message, type) {
        const existing = document.getElementById('bfcToast');
        if (existing) existing.remove();
        const toast = document.createElement('div');
        toast.id = 'bfcToast';
        const bg = type === 'success' ? '#10b981' : '#dc2626';
        toast.style.cssText = `position:fixed;bottom:28px;right:28px;z-index:9999;background:${bg};color:#fff;padding:14px 22px;border-radius:14px;font-weight:700;font-size:0.9rem;box-shadow:0 8px 24px rgba(0,0,0,0.18);display:flex;align-items:center;gap:10px;animation:fdSlideUp 0.3s ease;max-width:360px;`;
        const icon = type === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-triangle-fill';
        toast.innerHTML = `<i class="bi ${icon}"></i>${escHtml(message)}`;
        document.body.appendChild(toast);
        setTimeout(function() {
            toast.style.transition = 'opacity 0.4s';
            toast.style.opacity = '0';
            setTimeout(function() { toast.remove(); }, 400);
        }, 3200);
    }

    // ‚îÄ‚îÄ CSRF helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function getCsrfToken() {
        const el = document.querySelector('[name=csrfmiddlewaretoken]');
        if (el) return el.value;
        const match = document.cookie.match(/csrftoken=([^;]+)/);
        return match ? match[1] : '';
    }

    // Render structured blocks (paragraphs + tables) into a container element
    function renderDocBlocks(container, blocks) {
        if (!container) return;
        if (!blocks || blocks.length === 0) {
            container.innerHTML = '<span class="text-muted fst-italic">No readable content found.</span>';
            return;
        }
        let html = '';
        blocks.forEach(function(block) {
            if (block.type === 'paragraph') {
                html += `<p class="doc-para">${escHtml(block.text)}</p>`;
            } else if (block.type === 'table' && block.rows && block.rows.length > 0) {
                html += '<div class="doc-table-wrap"><table class="doc-table">';
                // First row as header
                html += '<thead><tr>';
                block.rows[0].forEach(function(cell) {
                    html += `<th>${escHtml(cell)}</th>`;
                });
                html += '</tr></thead><tbody>';
                for (let i = 1; i < block.rows.length; i++) {
                    html += '<tr>';
                    block.rows[i].forEach(function(cell) {
                        html += `<td>${escHtml(cell)}</td>`;
                    });
                    html += '</tr>';
                }
                html += '</tbody></table></div>';
            }
        });
        container.innerHTML = html || '<span class="text-muted fst-italic">No readable content found.</span>';
        container.dataset.loaded = '1';
    }

    function toggleDocText(btn, textUrl, forceClose) {
        const card   = btn ? btn.closest('.bfc-body') : null;
        const panel  = card ? card.querySelector('.doc-text-panel') : null;
        const textEl = card ? card.querySelector('.doc-text-content') : null;

        if (!panel) return;

        if (panel.classList.contains('open') || forceClose) {
            panel.classList.remove('open');
            if (btn) btn.innerHTML = '<i class="bi bi-eye me-1"></i>View Doc';
            return;
        }

        panel.classList.add('open');
        if (btn) btn.innerHTML = '<i class="bi bi-eye-slash me-1"></i>Hide Doc';

        // Already loaded ‚Äî don't re-fetch
        if (textEl && textEl.dataset.loaded) return;

        if (!textUrl) {
            if (textEl) textEl.innerHTML = '<span class="text-danger">Document URL not configured.</span>';
            return;
        }

        if (textEl) textEl.innerHTML = '<div class="text-center text-muted py-3"><div class="spinner-border spinner-border-sm"></div> Loading‚Ä¶</div>';

        fetch(textUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(function(r) { return r.json(); })
            .then(function(d) {
                if (!textEl) return;
                if (d.error) {
                    textEl.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>${escHtml(d.error)}</span>`;
                } else {
                    renderDocBlocks(textEl, d.blocks);
                }
            })
            .catch(function() {
                if (textEl) textEl.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>Failed to load document.</span>`;
            });
    }

    function closeDocPanel(bookingId) {
        const panel = document.getElementById('doc-panel-' + bookingId);
        if (!panel) return;
        panel.classList.remove('open');
        // Reset the View Doc button label
        const btn = panel.closest('.bfc-body') ? panel.closest('.bfc-body').querySelector('.btn-view-file') : null;
        if (btn) btn.innerHTML = '<i class="bi bi-eye me-1"></i>View Doc';
    }

    function openFileDetail(b) {
        const overlay = document.getElementById('fileDetailOverlay');
        const content = document.getElementById('fileDetailContent');
        const modal   = document.getElementById('bookingFilesModal');
        const docTextUrlTpl = modal ? modal.dataset.docTextUrl : null;
        const docPdfUrlTpl  = modal ? modal.dataset.docPdfUrl  : null;

        let docSection = '';
        if (b.has_doc_text) {
            const textUrl = docTextUrlTpl ? docTextUrlTpl.replace('/0/', '/' + b.id + '/') : null;
            const pdfUrl  = docPdfUrlTpl  ? docPdfUrlTpl.replace('/0/',  '/' + b.id + '/') : null;
            docSection = `
                <div style="background:#f8fafc;border-radius:14px;padding:16px 20px;border:1px solid #e2e8f0;margin-top:16px;">
                    <div style="font-weight:700;font-size:0.8rem;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px;">Attached Document</div>
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                        <div style="width:40px;height:40px;background:linear-gradient(135deg,#6366f1,#a855f7);border-radius:10px;display:flex;align-items:center;justify-content:center;">
                            <i class="bi bi-file-earmark-word" style="color:#fff;font-size:1.2rem;"></i>
                        </div>
                        <div style="flex:1;">
                            <div style="font-weight:700;color:#1e293b;font-size:0.9rem;">${escHtml(b.doc_name || 'Requirements Document')}</div>
                            <div style="font-size:0.78rem;color:#94a3b8;">Text extracted from uploaded document</div>
                        </div>
                        ${pdfUrl ? `<a href="${escHtml(pdfUrl)}" class="btn-dl-pdf" style="flex-shrink:0;"><i class="bi bi-file-earmark-pdf"></i> Download PDF</a>` : ''}
                    </div>
                    <div id="overlayDocText" style="background:#fff;border:1px solid #e2e8f0;border-radius:10px;padding:12px 14px;max-height:260px;overflow-y:auto;font-size:0.8rem;color:#334155;">
                        <div class="text-center text-muted py-2"><div class="spinner-border spinner-border-sm"></div> Loading‚Ä¶</div>
                    </div>
                </div>`;
            // Fetch and render blocks after DOM is set
            if (textUrl) {
                setTimeout(function() {
                    const el = document.getElementById('overlayDocText');
                    if (!el) return;
                    fetch(textUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                        .then(function(r) { return r.json(); })
                        .then(function(d) {
                            if (d.error) {
                                el.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>${escHtml(d.error)}</span>`;
                            } else {
                                renderDocBlocks(el, d.blocks);
                            }
                        })
                        .catch(function() { el.innerHTML = '<span class="text-danger">Failed to load document.</span>'; });
                }, 50);
            }
        } else {
            docSection = '<p class="text-muted small mt-3"><i class="bi bi-dash-circle me-1"></i>No document attached for this booking.</p>';
        }

        content.innerHTML = `
            <div style="display:flex;align-items:center;gap:14px;margin-bottom:22px;">
                <div style="width:52px;height:52px;background:linear-gradient(135deg,#6366f1,#a855f7);border-radius:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                    <i class="bi bi-building" style="color:#fff;font-size:1.5rem;"></i>
                </div>
                <div>
                    <h5 style="margin:0;font-weight:900;color:#1e293b;">${escHtml(b.room)}</h5>
                    <p style="margin:0;color:#64748b;font-size:0.85rem;">${b.from} &rarr; ${b.to}</p>
                </div>
            </div>
            <div style="background:#f8fafc;border-radius:14px;padding:14px 18px;border:1px solid #e2e8f0;margin-bottom:10px;">
                <div style="font-weight:700;font-size:0.78rem;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Faculty</div>
                <div style="font-weight:700;color:#1e293b;">${escHtml(b.faculty)}</div>
                <div style="color:#64748b;font-size:0.85rem;">${escHtml(b.email)}</div>
            </div>
            ${b.purpose ? `<div style="background:#f0f4ff;border-radius:14px;padding:14px 18px;border-left:4px solid #6366f1;margin-bottom:10px;">
                <div style="font-weight:700;font-size:0.78rem;color:#6366f1;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Purpose of Booking</div>
                <p style="margin:0;color:#1e293b;line-height:1.6;">${escHtml(b.purpose)}</p>
            </div>` : ''}
            ${docSection}
        `;

        overlay.classList.add('open');
    }

    function closeFileDetail() {
        document.getElementById('fileDetailOverlay').classList.remove('open');
    }

    // Close on overlay click
    document.addEventListener('DOMContentLoaded', function() {
        const ov = document.getElementById('fileDetailOverlay');
        if (ov) ov.addEventListener('click', function(e) { if (e.target === ov) closeFileDetail(); });

        // Close delete confirm on background click
        const dcOv = document.getElementById('bfcDeleteConfirmOverlay');
        if (dcOv) dcOv.addEventListener('click', function(e) { if (e.target === dcOv) closeBfcConfirm(); });

        // ‚îÄ‚îÄ Admin notification bell badge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function refreshAdminBellBadge() {
            fetch('{% url "central_admin:admin_notification_counts" %}')
                .then(function(r) { return r.ok ? r.json() : null; })
                .then(function(data) {
                    if (!data) return;
                    var badge = document.getElementById('adminBellBadge');
                    if (!badge) return;
                    if (data.total > 0) {
                        badge.textContent = data.total > 99 ? '99+' : data.total;
                        badge.style.display = 'block';
                        badge.style.animation = 'none';
                    } else {
                        badge.style.display = 'none';
                    }
                })
                .catch(function() {});
        }
        refreshAdminBellBadge();
        setInterval(refreshAdminBellBadge, 60000); // refresh every 60 seconds
    });
</script>
{% endblock content %}